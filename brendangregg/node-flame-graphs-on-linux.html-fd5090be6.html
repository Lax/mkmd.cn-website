<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>node.js Flame Graphs on Linux</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/blog/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/blog/css/main.css">

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7747513-3']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

    </head>
    <body>

	<div class="nav">
	<p class="navhdr">This Site:</p>
<a href="/index.html">Homepage</a><br>
<a href="/blog/index.html">Blog</a><br>
<a href="/sitemap.html">Full Site Map</a><br>
<a href="/sysperfbook.html">Sys Perf book</a><br>
<a href="/linuxperf.html">Linux Perf</a><br>
<a href="/methodology.html">Perf Methods</a><br>
<a href="/usemethod.html">USE Method</a><br>
<a href="/tsamethod.html">TSA Method</a><br>
<a href="/offcpuanalysis.html">Off-CPU Analysis</a><br>
<a href="/activebenchmarking.html">Active Bench.</a><br>
<a href="/flamegraphs.html">Flame Graphs</a><br>
<a href="/heatmaps.html">Heat Maps</a><br>
<a href="/frequencytrails.html">Frequency Trails</a><br>
<a href="/colonygraphs.html">Colony Graphs</a><br>
<a href="/perf.html">perf Examples</a><br>
<a href="/ktap.html">ktap Examples</a><br>
<a href="/dtrace.html">DTrace Tools</a><br>
<a href="/dtracetoolkit.html">DTraceToolkit</a><br>
<a href="/dtkshdemos.html">DtkshDemos</a><br>
<a href="/guessinggame.html">Guessing Game</a><br>
<a href="/specials.html">Specials</a><br>
<a href="/books.html">Books</a><br>
<a href="/sites.html">Other Sites</a><br>

	</div>

	<div class="recent">
	Recent posts:<br>
	<ul style="padding-left:18px">
	  
		   <li>17 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-17/node-flame-graphs-on-linux.html">  
		   node.js Flame Graphs on Linux</a></li>
	  
		   <li>15 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-15/the-msrs-of-ec2.html">  
		   The MSRs of EC2</a></li>
	  
		   <li>11 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-11/perf-kernel-line-tracing.html">  
		   Linux perf Rides the Rocket</a></li>
	  
		   <li>06 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-06/linux-ftrace-tcp-retransmit-tracing.html">  
		   Linux ftrace TCP Retransmit Tracing</a></li>
	  
		   <li>30 Aug 2014 &raquo;<br>
		   <a href="/blog/2014-08-30/ftrace-the-hidden-light-switch.html">  
		   ftrace: The Hidden Light Switch</a></li>
	  
		   <li>23 Aug 2014 &raquo;<br>
		   <a href="/blog/2014-08-23/linux-perf-tools-linuxcon-na-2014.html">  
		   Linux Performance Tools at LinuxCon North America 2014</a></li>
	  
		   <li>28 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-28/execsnoop-for-linux.html">  
		   execsnoop For Linux: See Short-Lived Processes</a></li>
	  
		   <li>25 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-25/opensnoop-for-linux.html">  
		   opensnoop For Linux</a></li>
	  
		   <li>23 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-23/linux-iosnoop-latency-heat-maps.html">  
		   Linux iosnoop Latency Heat Maps</a></li>
	  
		   <li>16 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-16/iosnoop-for-linux.html">  
		   iosnoop For Linux</a></li>
	  
		   <li>13 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-13/linux-ftrace-function-counting.html">  
		   Linux ftrace Function Counting</a></li>
	  
		   <li>10 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-10/perf-hacktogram.html">  
		   perf Hacktogram</a></li>
	  
		   <li>03 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-03/perf-counting.html">  
		   perf Counting</a></li>
	  
		   <li>01 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-01/perf-heat-maps.html">  
		   perf Heat Maps</a></li>
	  
		   <li>29 Jun 2014 &raquo;<br>
		   <a href="/blog/2014-06-29/perf-static-tracepoints.html">  
		   perf Static Tracepoints</a></li>
	  
		   <li>22 Jun 2014 &raquo;<br>
		   <a href="/blog/2014-06-22/perf-cpu-sample.html">  
		   perf CPU Sampling</a></li>
	  
		   <li>12 Jun 2014 &raquo;<br>
		   <a href="/blog/2014-06-12/java-flame-graphs.html">  
		   Java Flame Graphs</a></li>
	  
		   <li>09 Jun 2014 &raquo;<br>
		   <a href="/blog/2014-06-09/java-cpu-sampling-using-hprof.html">  
		   Java CPU Sampling Using hprof</a></li>
	  
		   <li>23 May 2014 &raquo;<br>
		   <a href="/blog/2014-05-23/osx-10.9.3-is-toxic.html">  
		   OS X 10.9.3 Recurring Panics</a></li>
	  
		   <li>17 May 2014 &raquo;<br>
		   <a href="/blog/2014-05-17/free-as-in-we-own-your-ip.html">  
		   Free, as in, We Own Your IP</a></li>
	  
	</ul>
	<a href="/blog/index.html">Blog index</a><br>
	<a href="/blog/about.html">About</a><br>
	<a href="/blog/rss.xml">RSS</a><br>
	</div>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/blog/index.html">Brendan Gregg's Blog</a></h1>
            <a class="extra" href="/blog/index.html">home</a>
          </div>

          <h2 class="big">node.js Flame Graphs on Linux</h2>
<p class="meta">17 Sep 2014</p>

<div class="post">
<p>CPU <a href="/flamegraphs.html">flame graphs</a> are a useful visualization application stack traces, allowing you to quickly identify and quantify what to tune to improve performance. For Node.js they have solved countless problems on systems which have DTrace for sampling stack traces. But what about Linux?</p>

<p>At Netflix we have node.js in production at scale, on Linux instances in AWS EC2, and we create flame graphs using Linux <a href="/perf.html">perf_events</a> and v8&#39;s <a href="https://codereview.chromium.org/70013002">--perf-basic-prof option</a>. In this quick blog post, I&#39;ll share how it works and how you can do it, and what needs to be fixed to improve it further.</p>

<h2>1. The problem</h2>

<p>Using perf_events to profile CPU usage on node.js 0.10.23:</p>

<p><object data="/blog/images/2014/node.js_flamegraph_nosymbols_01023.svg" type="image/svg+xml" width=720 height=875>
<img src="/blog/images/2014/node.js_flamegraph_nosymbols_01023.svg" width=720 />
</object></p>

<p>It&#39;s interactive: mouse-over elements for details, and click the <a href="/blog/images/2014/node.js_flamegraph_nosymbols_01023.svg">SVG</a> to zoom. The <a href="/FlameGraphs/cpuflamegraphs.html">CPU flame graphs</a> page explains how to interpret these, and this was created using the instructions in the <a href="/FlameGraphs/cpuflamegraphs.html#perf">Linux perf section</a>.</p>

<p>This flame graph is partially-useful, as I can see system and v8 library symbols. However, it is missing JavaScript symbols (the blank rectangles), since v8, like the JVM, compiles and places symbols just in time (JIT).</p>

<h2>2. Linux perf_events JIT support</h2>

<p>In 2009, Linux <a href="/perf.html">perf_events</a> added <a href="https://lkml.org/lkml/2009/6/8/499">JIT symbol support</a>, so that symbols from language virtual machines like the JVM could be inspected. It works in the following amazingly simple way:</p>

<ol>
<li>Your JIT application must be modified to create a /tmp/perf-<em>PID</em>.map file, which is a simple text database containing symbol addresses (in hex), sizes, and symbol names.</li>
<li>That&#39;s it.</li>
</ol>

<p>perf already looks for the /tmp/perf-<em>PID</em>.map file, and if it finds it, it uses it for symbol translations. So only v8 needed to be modified.</p>

<h2>3. v8 --perf-basic-prof support</h2>

<p>In November 2013, <a href="https://codereview.chromium.org/70013002">v8 added perf_events support</a>, enabled using the --perf-basic-prof option. This made it into node v0.11.13. It works like this:</p>

<pre>
# <b>~/node-v0.11.13-linux-x64/bin/node --perf-basic-prof hello.js &</b>
[1] 31441
# <b>ls -l /tmp/perf-31441.map</b>
-rw-r--r-- 1 root root 81920 Sep 17 20:41 /tmp/perf-31441.map
# <b>tail /tmp/perf-31441.map</b>
14cec4db98a0 f Stub:BinaryOpICWithAllocationSiteStub(ADD_CreateAllocationMementos:String*Generic->String)
14cec4db9920 f Stub:BinaryOpICWithAllocationSiteStub(ADD_CreateAllocationMementos:String*String->String)
14cec4db99a0 f Stub:BinaryOpICWithAllocationSiteStub(ADD_CreateAllocationMementos:String*Smi->String)
14cec4db9a20 22c LazyCompile:~nextTick node.js:389
14cec4db9cc0 156 Stub:KeyedLoadElementStub
14cec4db9e80 22 KeyedLoadIC:
14cec4db9f20 22 KeyedLoadIC:
14cec4db9fc0 56 Stub:DoubleToIStub
14cec4dba080 10c Stub:KeyedStoreElementStub
</pre>

<p>This text file is what perf_events reads.</p>

<h2>4. node.js Flame Graphs</h2>

<p>Now that we have node 0.11.13+ running with --perf-basic-prof, we can create a flame graph using:</p>

<pre>
$ <b>sudo bash</b>
# <b>perf record -F 99 -p `pgrep -n node` -g -- sleep 30</b>
# <b>perf script > out.nodestacks01</b>
# <b>git clone --depth 1 http://github.com/brendangregg/FlameGraph</b>
# <b>cd FlameGraph</b>
# <b>./stackcollapse-perf.pl < ../out.nodestacks01 | ./flamegraph.pl > ../out.nodestacks01.svg</b>
</pre>

<p>You can also use <a href="https://www.npmjs.org/package/stackvis">stackvis</a>, by Dave Pacheco, a node.js implementation which has extra features.</p>

<p>Here&#39;s an example result:</p>

<p><object data="/blog/images/2014/node.js_flamegraph_symbols_01113.svg" type="image/svg+xml" width=720 height=788>
<img src="/blog/images/2014/node.js_flamegraph_symbols_01113.svg" width=720 />
</object></p>

<p>Note the JavaScript symbols are now readable. Click the <a href="/blog/images/2014/node.js_flamegraph_symbols_01113.svg">SVG</a> to zoom in. This actual flame graph isn&#39;t very interesting, as I&#39;m just testing a dummy app to test out --perf-basic-prof.</p>

<p>Thanks to <a href="https://twitter.com/trevnorris">Trevor Norris</a> for first posting the instructions for doing this in a short <a href="https://gist.github.com/trevnorris/9616784">gist</a>, which you may find useful to read. He also provides a script to facilitate this.</p>

<h2>WARNING: map file growth</h2>

<p>We can currently only use --perf-basic-prof for short periods (hours), due to <a href="https://code.google.com/p/v8/issues/detail?id=3453">bug 3453</a>: the perf.map file can grow endlessly, eating Gbytes in a few days. It looks like symbols are moving location (they are supposed to stay put with --perf-basic-prof), causing the map file to keep growing.</p>

<p>So we can create flame graphs on Linux currently, but it will be ad hoc until that bug is fixed, and we can run with this option all the time.</p>

<p>If this bug is a nuisance to you, too, and it isn&#39;t yet fixed, please upvote that bug! If it&#39;s too painful to wait for the fix, you could run on an OS with DTrace, where node.js stack profiling doesn&#39;t have this issue (or, at least, run a canary instance for performance analysis).</p>

<h2>More</h2>

<p>We&#39;re doing more at Netflix with node.js analysis. Stay tuned, and also see the <a href="http://techblog.netflix.com/">Netflix Tech Blog</a>.</p>

</div>



<br><hr>
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'brendangregg';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


          <div class="footer">
            <div class="contact">
                Copyright 2014 Brendan Gregg.<br><a href="/blog/about.html">About this blog</a>
            </div>
          </div>
        </div>

    </body>
</html>
