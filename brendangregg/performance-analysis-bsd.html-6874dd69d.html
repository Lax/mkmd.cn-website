<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>MeetBSD CA: Performance Analysis of BSD</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/blog/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/blog/css/main.css">

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7747513-3']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

    </head>
    <body>

	<div class="nav">
	<p class="navhdr">This Site:</p>
<a href="/index.html">Homepage</a><br>
<a href="/blog/index.html">Blog</a><br>
<a href="/sitemap.html">Full Site Map</a><br>
<a href="/sysperfbook.html">Sys Perf book</a><br>
<a href="/linuxperf.html">Linux Perf</a><br>
<a href="/methodology.html">Perf Methods</a><br>
<a href="/usemethod.html">USE Method</a><br>
<a href="/tsamethod.html">TSA Method</a><br>
<a href="/offcpuanalysis.html">Off-CPU Analysis</a><br>
<a href="/activebenchmarking.html">Active Bench.</a><br>
<a href="/flamegraphs.html">Flame Graphs</a><br>
<a href="/heatmaps.html">Heat Maps</a><br>
<a href="/frequencytrails.html">Frequency Trails</a><br>
<a href="/colonygraphs.html">Colony Graphs</a><br>
<a href="/perf.html">perf Examples</a><br>
<a href="/ktap.html">ktap Examples</a><br>
<a href="/dtrace.html">DTrace Tools</a><br>
<a href="/dtracetoolkit.html">DTraceToolkit</a><br>
<a href="/dtkshdemos.html">DtkshDemos</a><br>
<a href="/guessinggame.html">Guessing Game</a><br>
<a href="/specials.html">Specials</a><br>
<a href="/books.html">Books</a><br>
<a href="/sites.html">Other Sites</a><br>

	</div>

	<div class="recent">
	Recent posts:<br>
	<ul style="padding-left:18px">
	  
		   <li>06 Mar 2015 &raquo;<br>
		   <a href="/blog/2015-03-06/performance-analysis-bsd.html">  
		   MeetBSD CA: Performance Analysis of BSD</a></li>
	  
		   <li>03 Mar 2015 &raquo;<br>
		   <a href="/blog/2015-03-03/performance-tuning-linux-instances-on-ec2.html">  
		   Performance Tuning Linux Instances on EC2</a></li>
	  
		   <li>28 Feb 2015 &raquo;<br>
		   <a href="/blog/2015-02-28/from-dtrace-to-linux.html">  
		   Tracing Summit 2014: From DTrace To Linux</a></li>
	  
		   <li>27 Feb 2015 &raquo;<br>
		   <a href="/blog/2015-02-27/linux-profiling-at-netflix.html">  
		   SCALE13x: Linux Profiling at Netflix</a></li>
	  
		   <li>26 Feb 2015 &raquo;<br>
		   <a href="/blog/2015-02-26/linux-perf-off-cpu-flame-graph.html">  
		   Linux perf_events Off-CPU Time Flame Graph</a></li>
	  
		   <li>20 Jan 2015 &raquo;<br>
		   <a href="/blog/2015-01-20/working-at-netflix.html">  
		   Working at Netflix</a></li>
	  
		   <li>31 Dec 2014 &raquo;<br>
		   <a href="/blog/2014-12-31/linux-page-cache-hit-ratio.html">  
		   Linux Page Cache Hit Ratio</a></li>
	  
		   <li>22 Nov 2014 &raquo;<br>
		   <a href="/blog/2014-11-22/linux-perf-tools-2014.html">  
		   Linux Performance Tools 2014</a></li>
	  
		   <li>09 Nov 2014 &raquo;<br>
		   <a href="/blog/2014-11-09/differential-flame-graphs.html">  
		   Differential Flame Graphs</a></li>
	  
		   <li>31 Oct 2014 &raquo;<br>
		   <a href="/blog/2014-10-31/cpi-flame-graphs.html">  
		   Catching Your CPUs Napping</a></li>
	  
		   <li>27 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-27/from-clouds-to-roots.html">  
		   From Clouds to Roots: Performance Analysis at Netflix</a></li>
	  
		   <li>17 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-17/node-flame-graphs-on-linux.html">  
		   node.js Flame Graphs on Linux</a></li>
	  
		   <li>15 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-15/the-msrs-of-ec2.html">  
		   The MSRs of EC2</a></li>
	  
		   <li>11 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-11/perf-kernel-line-tracing.html">  
		   Linux perf Rides the Rocket</a></li>
	  
		   <li>06 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-06/linux-ftrace-tcp-retransmit-tracing.html">  
		   Linux ftrace TCP Retransmit Tracing</a></li>
	  
		   <li>30 Aug 2014 &raquo;<br>
		   <a href="/blog/2014-08-30/ftrace-the-hidden-light-switch.html">  
		   ftrace: The Hidden Light Switch</a></li>
	  
		   <li>23 Aug 2014 &raquo;<br>
		   <a href="/blog/2014-08-23/linux-perf-tools-linuxcon-na-2014.html">  
		   Linux Performance Tools at LinuxCon North America 2014</a></li>
	  
		   <li>28 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-28/execsnoop-for-linux.html">  
		   execsnoop For Linux: See Short-Lived Processes</a></li>
	  
		   <li>25 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-25/opensnoop-for-linux.html">  
		   opensnoop For Linux</a></li>
	  
		   <li>23 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-23/linux-iosnoop-latency-heat-maps.html">  
		   Linux iosnoop Latency Heat Maps</a></li>
	  
	</ul>
	<a href="/blog/index.html">Blog index</a><br>
	<a href="/blog/about.html">About</a><br>
	<a href="/blog/rss.xml">RSS</a><br>
	</div>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/blog/index.html">Brendan Gregg's Blog</a></h1>
            <a class="extra" href="/blog/index.html">home</a>
          </div>

          <h2 class="big">MeetBSD CA: Performance Analysis of BSD</h2>
<p class="meta">06 Mar 2015</p>

<div class="post">
<p>System performance analysis is an enormous topic, and it&#39;s a challenge to know what can be analyzed and how. At the last <a href="https://www.meetbsd.com/">MeetBSD CA</a>, I gave a talk titled &quot;Performance Analysis&quot; where I discussed five key facets of this topic: observability tools, methodologies, benchmarking, profiling, and tracing. I&#39;d recommend this talk for anyone working in the BSD family of operating systems.</p>

<p>For the talk I created an observability tools diagram for FreeBSD:</p>

<p><center><a href="/Perf/freebsd_observability_tools.png"><img src="/Perf/freebsd_observability_tools.png" width="500" height="350"/></a></center></p>

<p>I have this, and my <a href="http://www.brendangregg.com/linuxperf.html">Linux</a> ones, printed out and hung up around my desk. It helps jog the memory, especially when I&#39;m switching between operating systems.</p>

<p>The slides for my talk are on <a href="http://www.slideshare.net/brendangregg/meetbsd2014-performance-analysis">slideshare</a>:</p>

<p><center><iframe src="http://www.slideshare.net/slideshow/embed_code/41022427" width="425" height="355" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe></center></p>

<p>The talk was also videoed (thanks, iXsystems), which is on <a href="https://www.youtube.com/watch?v=uvKMptfXtdo">youtube</a>:</p>

<p><center><iframe width="560" height="315" src="https://www.youtube.com/embed/uvKMptfXtdo" frameborder="0" allowfullscreen></iframe></center></p>

<p>Apart from the slide content, my talk included additional discussion and live demos of profiling the Netflix Open Connect Appliances (OCAs), which stream our content. I even did some cscope browsing of kernel source, to understand tracing targets.</p>

<p>FreeBSD has the most advanced performance analysis toolset, which includes pmcstat(8) for CPU performance monitoring counter (PMC) analysis, and DTrace for static and dynamic tracing. On Linux I can get the same jobs done, but it sometimes feels like I can&#39;t get out of second gear. On FreeBSD, I can fly.</p>

<p>For pmcstat(8), I came up with a neat diagram for the PMC groups:</p>

<p><center><a href="/Perf/freebsd_pmc_groups.png"><img src="/Perf/freebsd_pmc_groups.png" width="500" height="350"/></a></center></p>

<p>I&#39;m pretty happy with how this turned out. I do want to improve it next time I use it, and try to highlight frontend vs backend stall cycles, since that can be a useful approach for CPU analysis.</p>

<p>This is also an example of how more developed performance analysis is on FreeBSD: I tried to create this diagram for Linux perf_events for my SCALE 13x talk, but it was lacking so many PMC groups that I didn&#39;t use it. Linux can get the job done, but more often you&#39;ll need to use the raw PMC counter specifications from the Intel manual. Stuck in second gear again.</p>

<p>Just before the talk I published a collection of DTrace scripts (<a href="https://github.com/brendangregg/DTrace-tools">DTrace-tools</a>) which I wrote for the Netflix OCAs, and are installed by default. I&#39;ll find a better home for these (FreeBSD wiki or source).</p>

<p>In the talk I said I should have written a script beforehand for measuring storage I/O size, without using the DTrace io provider, as there is a bug in its translator (involving struct types). Here&#39;s one way, by instrumenting GEOM using dynamic tracing:</p>

<pre>
# <b>dtrace -n 'fbt::g_disk_start:entry { @ = quantize(args[0]->bio_length); }'</b>
dtrace: description 'fbt::g_disk_start:entry ' matched 1 probe
^C

           value  ------------- Distribution ------------- count    
            2048 |                                         0        
            4096 |@@                                       196      
            8192 |@                                        147      
           16384 |                                         4        
           32768 |                                         1        
           65536 |                                         32       
          131072 |                                         0        
          262144 |                                         0        
          524288 |                                         0        
         1048576 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@    4799     
         2097152 |                                         0  
</pre>

<p>This histogram shows that most of the I/O fell into the 1-2 Mbyte bucket, which explains the 1 millisecond minimum latency from my demo. These Netflix OCAs are tuned for streaming workloads.</p>

<p>I enjoyed meeting others in the BSD community at MeetBSD CA, and watching the talks. I was a little surprised at how welcoming, happy, and <em>relaxed</em> the BSD community is. I&#39;ve been to Linux events recently (SCALE is an exception) where the mood felt a bit tense: hallway conversations were about Linus&#39;s attitude, and whether that&#39;s ok, and how much people hate or love systemd. Things are currently much more relaxed in BSD land!</p>

<p>I hope you like my talk. Check out the <a href="https://www.youtube.com/playlist?list=PLb87fdKUIo8TijlK7TuBeRMgylGaN9Ec9">playlist</a> for other MeetBSD CA talks. The day after this talk, I gave another on FreeBSD flame graphs, which I&#39;ll describe in a follow up post.</p>

</div>



<br><hr>
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'brendangregg';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


          <div class="footer">
            <div class="contact">
                Copyright 2015 Brendan Gregg.<br><a href="/blog/about.html">About this blog</a>
            </div>
          </div>
        </div>

    </body>
</html>
