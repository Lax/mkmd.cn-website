<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>What Color Is Your Xen?</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/blog/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/blog/css/main.css">

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7747513-3']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

    </head>
    <body>

	<div class="nav">
	<p class="navhdr">This Site:</p>
<a href="/index.html">Homepage</a><br>
<a href="/blog/index.html">Blog</a><br>
<a href="/sitemap.html">Full Site Map</a><br>
<a href="/sysperfbook.html">Sys Perf book</a><br>
<a href="/linuxperf.html">Linux Perf</a><br>
<a href="/methodology.html">Perf Methods</a><br>
<a href="/usemethod.html">USE Method</a><br>
<a href="/tsamethod.html">TSA Method</a><br>
<a href="/offcpuanalysis.html">Off-CPU Analysis</a><br>
<a href="/activebenchmarking.html">Active Bench.</a><br>
<a href="/flamegraphs.html">Flame Graphs</a><br>
<a href="/heatmaps.html">Heat Maps</a><br>
<a href="/frequencytrails.html">Frequency Trails</a><br>
<a href="/colonygraphs.html">Colony Graphs</a><br>
<a href="/perf.html">perf Examples</a><br>
<a href="/ktap.html">ktap Examples</a><br>
<a href="/dtrace.html">DTrace Tools</a><br>
<a href="/dtracetoolkit.html">DTraceToolkit</a><br>
<a href="/dtkshdemos.html">DtkshDemos</a><br>
<a href="/guessinggame.html">Guessing Game</a><br>
<a href="/specials.html">Specials</a><br>
<a href="/books.html">Books</a><br>
<a href="/sites.html">Other Sites</a><br>

	</div>

	<div class="recent">
	Recent posts:<br>
	<ul style="padding-left:18px">
	  
		   <li>30 Aug 2014 &raquo;<br>
		   <a href="/blog/2014-08-30/ftrace-the-hidden-light-switch.html">  
		   ftrace: The Hidden Light Switch</a></li>
	  
		   <li>23 Aug 2014 &raquo;<br>
		   <a href="/blog/2014-08-23/linux-perf-tools-linuxcon-na-2014.html">  
		   Linux Performance Tools at LinuxCon North America 2014</a></li>
	  
		   <li>28 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-28/execsnoop-for-linux.html">  
		   execsnoop For Linux: See Short-Lived Processes</a></li>
	  
		   <li>25 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-25/opensnoop-for-linux.html">  
		   opensnoop For Linux</a></li>
	  
		   <li>23 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-23/linux-iosnoop-latency-heat-maps.html">  
		   Linux iosnoop Latency Heat Maps</a></li>
	  
		   <li>16 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-16/iosnoop-for-linux.html">  
		   iosnoop For Linux</a></li>
	  
		   <li>13 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-13/linux-ftrace-function-counting.html">  
		   Linux ftrace Function Counting</a></li>
	  
		   <li>10 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-10/perf-hacktogram.html">  
		   perf Hacktogram</a></li>
	  
		   <li>03 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-03/perf-counting.html">  
		   perf Counting</a></li>
	  
		   <li>01 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-01/perf-heat-maps.html">  
		   perf Heat Maps</a></li>
	  
		   <li>29 Jun 2014 &raquo;<br>
		   <a href="/blog/2014-06-29/perf-static-tracepoints.html">  
		   perf Static Tracepoints</a></li>
	  
		   <li>22 Jun 2014 &raquo;<br>
		   <a href="/blog/2014-06-22/perf-cpu-sample.html">  
		   perf CPU Sampling</a></li>
	  
		   <li>12 Jun 2014 &raquo;<br>
		   <a href="/blog/2014-06-12/java-flame-graphs.html">  
		   Java Flame Graphs</a></li>
	  
		   <li>09 Jun 2014 &raquo;<br>
		   <a href="/blog/2014-06-09/java-cpu-sampling-using-hprof.html">  
		   Java CPU Sampling Using hprof</a></li>
	  
		   <li>23 May 2014 &raquo;<br>
		   <a href="/blog/2014-05-23/osx-10.9.3-is-toxic.html">  
		   OS X 10.9.3 Recurring Panics</a></li>
	  
		   <li>17 May 2014 &raquo;<br>
		   <a href="/blog/2014-05-17/free-as-in-we-own-your-ip.html">  
		   Free, as in, We Own Your IP</a></li>
	  
		   <li>16 May 2014 &raquo;<br>
		   <a href="/blog/2014-05-16/LISA13-metrics-workshop.html">  
		   LISA13 Metrics Workshop</a></li>
	  
		   <li>11 May 2014 &raquo;<br>
		   <a href="/blog/2014-05-11/strace-wow-much-syscall.html">  
		   strace Wow Much Syscall</a></li>
	  
		   <li>09 May 2014 &raquo;<br>
		   <a href="/blog/2014-05-09/xen-feature-detection.html">  
		   Xen Feature Detection</a></li>
	  
		   <li>07 May 2014 &raquo;<br>
		   <a href="/blog/2014-05-07/what-color-is-your-xen.html">  
		   What Color Is Your Xen?</a></li>
	  
	</ul>
	<a href="/blog/index.html">Blog index</a><br>
	<a href="/blog/about.html">About</a><br>
	<a href="/blog/rss.xml">RSS</a><br>
	</div>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/blog/index.html">Brendan Gregg's Blog</a></h1>
            <a class="extra" href="/blog/index.html">home</a>
          </div>

          <h2 class="big">What Color Is Your Xen?</h2>
<p class="meta">07 May 2014</p>

<div class="post">
<p>What&#39;s faster: <strong>PV</strong>, <strong>HVM</strong>, <strong>HVM with PV drivers</strong>, <strong>PVHVM</strong>, or <strong>PVH</strong>? Cloud computing providers using <a href="http://www.xenproject.org">Xen</a> can offer different virtualization &quot;modes&quot;, based on paravirtualization (PV), hardware virtual machine (HVM), or a hybrid of them. As a customer, you may be required to choose one of these. So, which one?</p>

<p>Rackspace offers <a href="http://www.rackspace.com/knowledge_center/article/choosing-a-virtualization-mode-pv-versus-pvhvm">PV or PVHVM</a>, and Amazon EC2 offers <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html">PV or HVM</a>. I&#39;d summarize the choice today as:</p>

<blockquote>The best performance is the latest PV/HVM hybrid mode that Xen supports.</blockquote>

<p>For most places right now, PVHVM should deliver the best performance. On AWS EC2, if you create a &quot;HVM&quot; instance, and Linux supports it, you get PVHVM.
In the future (Xen 4.4+) the fastest mode will be <a href="http://blog.xen.org/index.php/2014/01/31/linux-3-14-and-pvh/">PVH</a>. </p>

<p>Not picking the latest hybrid mode should only make sense for some corner cases. You can test this yourself, as your mileage and requirements may vary.</p>

<p>Now, if you search for <a href="http://lmgtfy.com/?q=PV+vs+HVM">PV vs HVM</a>, the more you read the more confused you may become.  My first hit was a post from 2012 discussing EC2 choices, concluding with:</p>

<blockquote>"If you want a good performance for Linux/Unix then use PV"</blockquote>

<p>You might still be thinking the same, and a while ago this was right, before many changes in the world of Xen (before PV drivers on HVM, PVHVM, and PVH). At least the post from 2012 has a date on it (like this one).</p>

<p>What makes this even more confusing is that never versions of the hybrid model have been named as separate &quot;modes&quot;. In this post, I&#39;ll summarize the current virtualization spectrum model, and suggest a slightly different explanation: instead of focusing on the choice of modes, I&#39;ll show them as an evolution of versions.</p>

<p>Note that I&#39;m not a Xen developer, so I&#39;m not an official source of Truth for this: I&#39;m a performance architect for a large EC2 user, and I&#39;m hoping to contribute to our collective understanding of Xen choices.</p>

<h2>The Virtualization Spectrum</h2>

<div style="float:right;padding:10px;padding-top:0px"><a href="/blog/images/2014/xen-virt-spectrum-crop-800.png"><img border=0 src="/blog/images/2014/xen-virt-spectrum-crop-800.png" width=400></a></div>

<p>In the articles <a href="http://blog.xen.org/index.php/2012/10/23/the-paravirtualization-spectrum-part-1-the-ends-of-the-spectrum/">The Ends of the Spectrum</a> and <a href="http://blog.xen.org/index.php/2012/10/31/the-paravirtualization-spectrum-part-2-from-poles-to-a-spectrum/">From Poles to a Spectrum</a>, George Dunlap introduced the idea that there are no longer two modes of Xen virtualization &ndash; PV or HVM &ndash; but, rather, a spectrum of modes, where PV and HVM are the poles.</p>

<p>This is pictured in the right diagram <a href="http://www.slideshare.net/xen_com_mgr/linuxcon-eu-virtualization-in-the-cloud-featuring-xen-and-xcp/16">from Lars Kurth</a>, which lists different Xen virtualization modes as rows, and features as columns. Full HVM mode is the top row, full PV mode is the bottom, and hybrid modes are in-between. (This shows PVH as a Xen 4.3 feature; it&#39;s now Xen 4.4.)</p>

<p>The HVM and PV technologies provide their own performance benefits:</p>

<ul>
<li><strong>HVM</strong>: A processor technology for accelerating CPU virtualization (privileged instructions, syscalls) and the MMU (page tables). This is supported by Intel (VT-x) and AMD (AMD-V).</li>
<li><strong>PV</strong>: A software technology where the guest kernel can use an accelerated interface for virtualized components, including disks and network interfaces, rather than emulating hardware.</li>
</ul>

<p>Xen has been developing additional hybrid modes for the best of both words, where a HVM guest can use faster PV kernel parts, or vice versa. At first, PV disk and network drivers on HVM were possible. Then, interrupts and timers. Each of these moves reduced the need for slower emulation, such as via QEMU, improving performance. This is all summarized pretty well by the spectrum diagram.</p>

<p>You can find more detailed explanations of the modes in those <a href="http://blog.xen.org/index.php/2012/10/23/the-paravirtualization-spectrum-part-1-the-ends-of-the-spectrum/">two</a> <a href="http://blog.xen.org/index.php/2012/10/31/the-paravirtualization-spectrum-part-2-from-poles-to-a-spectrum/">articles</a>. As George suggested, PVH is expected to be the best hybrid mode, and that other modes could eventually be dropped from the Linux kernel, simplifying it. And, if HVM existed (the Intel VT-x or AMD-V processor features) when Xen was written, PVH would probably have been the chosen mode.</p>

<h2>The Colors of Xen</h2>

<p>So Xen today is something of a mess &ndash; the result of evolving software and hardware features, aiming to provide the best performance possible. And, as George noted in his first article, the terminology has been a little unclear, and has evolved over time.</p>

<p>The spectrum of modes is great way to make sense of this, but there are some loose ends. One is that a spectrum of modes can imply a choice when doesn&#39;t need to be one: if my instance supports PVHVM, should I study its pros and cons versus PV drivers over HVM? No, PVHVM is just the latest version of the same thing. So, instead of a spectrum of modes, is it more a spectrum of versions?</p>

<div style="float:right;padding:10px;padding-top:0px"><a href="/blog/images/2014/cosby-xen-modes.jpg"><img border=0 src="/blog/images/2014/cosby-xen-modes.jpg" width=250></a></div>

<p>There are other sources of confusion: George&#39;s <a href="http://blog.xen.org/index.php/2012/10/31/the-paravirtualization-spectrum-part-2-from-poles-to-a-spectrum/">article</a> describes &quot;PVHVM mode&quot; and &quot;PVH mode&quot;, then depicts them inside &quot;HVM mode&quot; and &quot;PV mode&quot; groups, which are labeled as &quot;mode/domain&quot; in the above figure. So &quot;PVHVM <em>mode</em>&quot; is a <em>mode</em>, but &quot;PV <em>mode</em>&quot; is a <em>domain</em> or group of modes?</p>

<p>His article also warns about PVHVM mode confusion:</p>

<blockquote>("PVHVM" mode should not be confused with "PV-on-HVM" mode, which is a term sometimes used in the past for "fully virtualized with PV drivers".)</blockquote>

<p>I understand this statement, however, many sources seem to still misuse the terms: the Xen wiki page on <a href="http://wiki.xen.org/wiki/PV_on_HVM">PV on HVM</a> describes this as &quot;also called PVHVM or PV-on-HVM drivers&quot;, which seems to contradict the warning. Also, what I think are the developer&#39;s slides on PVHVM are actually titled &quot;<a href="http://www.slideshare.net/xen_com_mgr/6-stefano-spvhvm">Linux PV on HVM</a>&quot;. Maybe I&#39;m wrong and these are consistent, but I struggle to see how.</p>

<h2>Back to Poles</h2>

<p>Here&#39;s a different way to think about the modes, if it helps. Lets go back to the poles model (PV and HVM), before the spectrum, and explain the current state of Xen in that context.</p>

<div style="float:right;padding:10px;padding-top:0px"><a href="/blog/images/2014/xen-mode-flow.png"><img border=0 src="/blog/images/2014/xen-mode-flow.png" width=270></a></div>

<p>In this model, there are only two modes to worry about, PV and HVM, and each mode may support additional features to improve performance:</p>

<ul>
<li><strong>PV</strong>: Use this if the PVH feature is supported, which boots the best type of hybrid. You may also need to choose this if the processor doesn&#39;t do HVM: eg, following the EC2 <a href="http://aws.amazon.com/amazon-linux-ami/instance-type-matrix/">instance type matrix</a>, where you will end up with a fully PV mode instance.</li>
<li><strong>HVM</strong>: Until PVH, choose this. Xen, and the guest kernel, are likely to support a number of enhancements which use PV code paths, so the booted instance will be a hybrid. The number of enhancements depends on the Xen and guest kernel versions: newer for more.</li>
</ul>

<p>This selection of instances is pictured in the flowchart on the right. It shows what can be selected to achieve the highest performance, in general. You may have a corner case that differs, due to different requirements.</p>

<p>PVHVM and PVH can be thought of as features and not modes. The choices are PV or HVM, which describes how the instance boots, and your choice may be influenced by the features available. Currently, on EC2, PVH is not available, but PVHVM is: so the best choice for Linux (in general) would be booting a &quot;HVM&quot; instance with PVHVM enabled (eg, setting CONFIG_XEN_PVHVM).</p>

<div style="float:right;padding:10px;padding-top:0px"><a href="/blog/images/2014/xen-colors.png"><img border=0 src="/blog/images/2014/xen-colors.png" width=400></a></div>

<p>I&#39;ve redrawn the spectrum picture on the right to emphasize the two modes, and to group all mixed types as &quot;Hybrid&quot;, showing that they are a progression of Xen versions, rather than a group of modes to choose from. Is this helpful?</p>

<p>If you don&#39;t find this an improvement, I&#39;ll try a different way to clarify what your Xen guest is doing in my next post, where I&#39;ll cover tools for feature detection.</p>

<h2>Enhanced Networking</h2>

<p>While my spectrum diagram may be an improvement, I&#39;ve left a loose end untied: <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/enhanced-networking.html">SR-IOV for enhanced networking</a>. If the instance type supports it, this uses hardware virtualization enhancements to improve performance and provide an interface better suited for virtualization. In some ways, this is an evolution of I/O controllers that is similar to what processors have done, with their own virtualization extensions.</p>

<p>SR-IOV, if you can enable it, should provide the best I/O performance. So perhaps the first feature column in the spectrum diagram should really show two options: P (paravirt) as yellow, and VH (SR-IOV) as green. Here&#39;s how it <a href="/blog/images/2014/xen-colors-sriov.png">looks</a> (although I&#39;m not sure all the hybrid types support SR-IOV).</p>

<h2>Conclusion</h2>

<p>Nowadays, there are various hybrid Xen modes (or versions), which obsolete older advice that &quot;PV is fastest&quot;. On AWS EC2 today, &quot;HVM&quot; mode (which supports PVHVM) should be fastest. In the future, it will be PVH. If you can, you can also enable SR-IOV to improve I/O performance further.</p>

<p>In this post I summarized the spectrum model of the modes, and described them a little differently in terms of the earlier PV or HVM model. The number of Xen modes is a little confusing, and is a result of an evolution of software and hardware, and Xen development work to deliver the fastest guests they can.</p>

<p>A while ago I wrote a post on <a href="http://dtrace.org/blogs/brendan/2013/01/11/virtualization-performance-zones-kvm-xen/">the performance of Zones vs KVM vs Xen</a>, and for Xen I pictured a fully HVM instance with the QEMU I/O proxy, mentioning that paravirtualization drivers could improve I/O performance. That how I&#39;d draw the digram today: as I/O should be using the faster PV drivers, even for <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/Upgrading_PV_drivers.html">Windows</a>.</p>

<p>Despite the Xen improvements, Solaris Zones, or Linux containers, should still be the fastest possible virtualization option, allowing guests to run bare-metal everything. But there is still a road ahead for their widespread adoption: a topic for another post.</p>

<p>In my <a href="/blog/2014-05-09/xen-feature-detection.html">next post</a>, I show various tools you can use from your Linux Xen guest to detect which HVM and PV features are enabled.</p>

<h2>References and Resources</h2>

<ul>
<li>George Dunlap&#39;s <a href="http://blog.xen.org/index.php/2012/10/23/the-paravirtualization-spectrum-part-1-the-ends-of-the-spectrum/">The Ends of the Spectrum</a> and <a href="http://blog.xen.org/index.php/2012/10/31/the-paravirtualization-spectrum-part-2-from-poles-to-a-spectrum/">From Poles to a Spectrum</a> are the best summary of all the modes, and how these have been developed (evolved) little by little.</li>
<li>Lars Kurth&#39;s talk <a href="http://www.slideshare.net/xen_com_mgr/linuxcon-eu-virtualization-in-the-cloud-featuring-xen-and-xcp/16">Virtualization in the Cloud Featuring Xen</a>.</li>
<li>Stefano Stabellini&#39;s <a href="http://www.slideshare.net/xen_com_mgr/6-stefano-spvhvm">Linux PV on HVM</a>, and especially the <a href="http://vimeo.com/33056481">video</a>, give the best insight into why the PVHVM features were developed, and the value they bring.</li>
<li>The <a href="http://wiki.xen.org/wiki/Xen_Linux_PV_on_HVM_drivers">Xen Linux PV on HVM drivers</a> shows more commands for studying Xen configuration.</li>
<li>Also see the Xen wiki <a href="http://wiki.xen.org/wiki/PV_on_HVM">PV on HVM</a> page.</li>
<li><a href="http://blog.xen.org/index.php/2014/01/31/linux-3-14-and-pvh/">Linux 3.14 and PVH</a>, describing how to get the development version working.</li>
<li>See the <a href="http://www.slideshare.net/xen_com_mgr/xen-project-4-4-features-and-futures">Xen Project 4.4</a> slides by Russell Pavlicek, Mar 27, 2014, for a recent summary.</li>
<li>The AWS <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html">EC2 instance types</a> does explain that &quot;HVM&quot; isn&#39;t fully &quot;HVM&quot;.</li>
<li>The AWS <a href="http://docs.aws.amazon.com/general/latest/gr/glos-chap.html#H">glossary</a> also defines &quot;HVM&quot;.</li>
<li>Rackspace <a href="http://www.rackspace.com/knowledge_center/article/choosing-a-virtualization-mode-pv-versus-pvhvm">choosing PV vs PVHVM</a>.</li>
<li>EC2 <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/enhanced-networking.html">enhanced nerworking (SR-IOV)</a>.</li>
<li>The first hit from google for <a href="http://palakonda.org/2012/10/30/aws-virtualization-hvm-vs-paravirtualization/">PV vs HVM</a> (out of date).</li>
<li>Moolah ecommerce <a href="http://moolah-ecommerce.com/blog/36-2014/219-amazon-vs-rackspace-performance">benchmarked</a> the difference between PV and PVHVM, using <em><a href="http://www.brendangregg.com/blog/2014-05-02/compilers-love-messing-with-benchmarks.html">UnixBench</a></em>?</li>
<li>Xen Orchestra has also benchmarked <a href="https://xen-orchestra.com/debian-pvhvm-vs-pv/">Debian PVHVM vs PV</a> using ... <em>UnixBench? again?? (flips desk.)</em></li>
</ul>

<p>Thanks to the AWS performance engineers for helping me understand this better.</p>

</div>



<br><hr>
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'brendangregg';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


          <div class="footer">
            <div class="contact">
                Copyright 2014 Brendan Gregg.<br><a href="/blog/about.html">About this blog</a>
            </div>
          </div>
        </div>

    </body>
</html>
