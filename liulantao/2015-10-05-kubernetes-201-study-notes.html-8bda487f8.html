<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="description" content="Idea, Code, Life 思考的点点滴滴">
<meta name="keywords" content="HTML, CSS, JS, JavaScript, framework, bootstrap, front-end, frontend, web development, showcase, expo">
<meta name="author" content="Lax" />

<title>
  
    Kubernetes 201 学习笔记 &#124; Peek Poke
  
</title>

<link rel="stylesheet" href="/blog/css/jekyll.css">
<script src="/blog/js/jekyll.js"></script>

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="RSS" href="/blog/feed.xml">
<link rel="alternate" type="application/atom+xml" title="Atom" href="/blog/atom.xml" />

<!-- Favicons -->
<link rel="icon" href="/blog/favicon.ico">
<link rel="apple-touch-icon" href="/blog/apple-touch-icon.png">

  </head>
  <body data-spy="scroll" data-target="#toc">
    <div class="container">
  <div class="header clearfix">
    <nav>
      <ul class="nav nav-pills pull-right">
        <li class="nav-item">
          <a class="nav-link" href="/">Home</a>
        </li>
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            
              <li class="nav-item">
                <a class="nav-link" href="/about/">关于我</a>
              </li>
            
          
        
          
        
          
            
              <li class="nav-item">
                <a class="nav-link" href="/documents/">文档</a>
              </li>
            
          
        
          
        
          
        
          
        
          
        
          
            
              <li class="nav-item">
                <a class="nav-link" href="/links/">资源链接</a>
              </li>
            
          
        
          
        
          
            
              <li class="nav-item">
                <a class="nav-link" href="/projects/">项目</a>
              </li>
            
          
        
          
        
          
        
          
        
          
        
      </ul>
    </nav>
    <h3 class="text-muted" data-toc-skip><a href="/">Peek Poke</a></h3>
  </div>
</div>


    <div class="container">
      <div class="post">

  <header class="post-header">
    <h1>Kubernetes 201 学习笔记</h1>
    <p class="meta">Oct 5, 2015</p>
    
<share>
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style"><span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_tsina" data-proofer-ignore></a>
<a class="jiathis_button_weixin" data-proofer-ignore></a>
<a class="jiathis_button_twitter" data-proofer-ignore></a>
<a class="jiathis_button_linkedin" data-proofer-ignore></a>
<a class="jiathis_button_instapaper" data-proofer-ignore></a>
<a class="jiathis_button_fav" data-proofer-ignore></a>
<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
<a class="jiathis_counter_style" data-proofer-ignore></a>
</div>
<script type="text/javascript" >
var jiathis_config={
	sm:"tsina,weixin,fav,copy,twitter,linkedin",
	summary:"",
	ralateuid:{
		"tsina":"1653644220"
	},
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

</share>


  </header>

  <div class="clearfix"></div>

  <hr class="masthead-hr">

  <div class="row">
    <div class="col-sm-9">
      <article class="post-content">
      <p>Kubernetes 201 涵盖了 <a href="/blog/2015/2015-09-30-kubernetes-101-study-notes.html">Kubernetes 101</a> 未涉及的领域和更高级的话题，如应用生产化，部署和扩展。</p>

<!--excerpt-->

<p>大致的知识树如下：</p>

<ul>
  <li>Kubernetes 201 - Labels, Replication Controllers, Services and Health Checking
    <ul>
      <li>Labels</li>
      <li>Replication Controllers
        <ul>
          <li>Replication Controller Management</li>
        </ul>
      </li>
      <li>Services
        <ul>
          <li>Service Management</li>
        </ul>
      </li>
      <li>Health Checking
        <ul>
          <li>Process Health Checking</li>
          <li>Application Health Checking</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="labels">Labels</h3>

<p>了解 Pods 概念并会创建后，你一定想创建原来越多的 pod。
加油干吧！</p>

<p>但是你逐渐会需要一个体系来组织这些 pod，做好分组。</p>

<p>Kubernetes 中实现这一目的的系统是 Labels。
Labels 是 key-value 对，附属于 Kubernetes 中每一个对象。
可以使用 RESTful 的 <code class="highlighter-rouge">list</code> 操作做 Label 选择，发送到 api 服务器，获取满足 label 选择条件的对象列表。</p>

<p>增加一个 label，只要在 pod 定义的元数据部分以下写 labels 即可：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>labels:
    app: nginx
</code></pre>
</div>

<p>以下是一个 nginx pod 定义示例，包含了 label：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx
    ports:
    - containerPort: 80
</code></pre>
</div>

<p>创建一个有 label 的 pod：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f docs/user-guide/walkthrough/pod-nginx-with-label.yaml
</code></pre>
</div>

<p>列出所有具有 label <code class="highlighter-rouge">app=nginx</code> 的 pod：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl get pods -l app=nginx
</code></pre>
</div>

<p><a href="http://kubernetes.io/v1.0/docs/user-guide/labels.html">关于 Labels</a></p>

<p>Label 是 Kubernetes 构建链上两个部分（Replication Controllers 和 Services）的核心概念。</p>

<h3 id="replication-controllers">Replication Controllers</h3>

<p>OK，你知道如何构建超棒的、多容器、有标签的 pod，
想用他们构建应用程序，
也许已经开始建立了一堆独立的 pod，
但如果你这么做了，
一系列操作问题会出现。</p>

<p>比如：如何向上或向下扩展 pod 的数量，如何保证所有 pod 同质同源？</p>

<p>Replication controller （副本控制器）回答了这一问题。
Replicatin controller 将 pod 创建的模版和所需副本数，结合到单一的 Kubernetes 对象里。
它还包含一个标签选择器，表示副本控制器管理的对象集合。</p>

<p>副本控制器持续测量对象集合大小与所需大小的差异，采取行动创建或删除 pod。</p>

<p>例如，一个副本控制器，初始化两个 nginx pod：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apiVersion: v1
kind: ReplicationController
metadata:
  name: nginx-controller
spec:
  replicas: 2
  # selector identifies the set of Pods that this
  # replication controller is responsible for managing
  selector:
    app: nginx
  # podTemplate defines the 'cookie cutter' used for creating
  # new pods when necessary
  template:
    metadata:
      labels:
        # Important: these labels need to match the selector above
        # The api server enforces this constraint.
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80
</code></pre>
</div>

<h4 id="replication-controller-management">Replication Controller Management</h4>

<p>创建一个副本控制器：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f docs/user-guide/walkthrough/replication-controller.yaml
</code></pre>
</div>

<p>列出所有副本控制器：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl get rc
</code></pre>
</div>

<p>通过名字删除副本控制器：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl delete rc nginx-controller
</code></pre>
</div>

<p><a href="http://kubernetes.io/v1.0/docs/user-guide/replication-controller.html">Replication Controllers</a></p>

<h3 id="services">Services</h3>

<p>一旦有一套 pod 的副本，就需要一个抽象层，使应用的各层之间联系起来。
例如，如果有复制控制器管理后台任务，就不希望每次后端扩展后都需要重现配置前端程序。
同样，如果后台任务被计划调度到不同机器上，也不应该被要求重新配置前端程序。</p>

<p>在 Kubernetes 里，Service(服务)实现这些目标。</p>

<p>Service 提供了通过静态 ip 指向一组（用 label 选择出来的） pod 的方式。
如果提供商支持，也可以提供负载均衡。</p>

<p>例如，基于前文 nginx 副本控制器例子创建的 pod，这个 service 提供了负载均衡：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  ports:
  - port: 8000 # the port that this service should serve on
    # the container on each pod to connect to, can be a name
    # (e.g. 'www') or a number (e.g. 80)
    targetPort: 80
    protocol: TCP
  # just like the selector in the replication controller,
  # but this time it identifies the set of pods to load balance
  # traffic to.
  selector:
    app: nginx
</code></pre>
</div>

<h4 id="service-management">Service Management</h4>

<p>创建一个 nginx 服务：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f docs/user-guide/walkthrough/service.yaml
</code></pre>
</div>

<p>列出所有服务：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl get services
</code></pre>
</div>

<p>大多数提供商的服务 IP 无法从外部访问。
测试服务工作的最简单方式是创建一个 busybox pod，通过它执行命令。</p>

<p>服务 IP 可用时，能够用 curl 在 80 端口访问：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ export SERVICE_IP=$(kubectl get service nginx-service -o=template -t={{.spec.clusterIP}})
$ export SERVICE_PORT=$(kubectl get service nginx-service -o=template '-t={{(index .spec.ports 0).port}}')
$ curl http://${SERVICE_IP}:${SERVICE_PORT}
</code></pre>
</div>

<p>通过名字删除服务：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl delete service nginx-controller
</code></pre>
</div>

<p>每个服务创建时，都分配了唯一的 IP 地址。
这个地址绑定在 Service 的整个生命周期，并且不回改变。</p>

<p>Pod 可以配置与 Service 进行通讯，与 Service 的数据交换会自动负载均衡到 Service 选择条件所选择出来的一个成员 pod 上。</p>

<p><a href="http://kubernetes.io/v1.0/docs/user-guide/services.html">Services</a></p>

<h3 id="health-checking">Health Checking</h3>

<p><em>我写的代码永远不会崩溃</em>，是吗？
可悲的是 Kubernetes 邮件列表里显示正好相反……</p>

<p>与其试图写出无 bug 的代码，不如使用一个管理工具来定期做健康检查并修复。
由一个应用外部的系统负责监视应用程序和采取修复措施。
在外部做检查很重要，因为如果健康检查是应用的一部分，应用程序失效时它也可能也失效，而你并不知晓。</p>

<p>在 Kubernetes 中，健康监控程序是 Kubelet 客服端。</p>

<h4 id="process-health-checking">Process Health Checking</h4>

<p>监控检查最简单的形式是进程级别的监控检查。
Kubelet 持续向 Docker 服务询问容器进程是否在运行，如果失败，容器进程被重新启动。</p>

<p>目前我们所运行的 Kubernetes 例子中，健康检查都已经启用。
Kubernetes 中每一个容器，健康检查都是开启的状态。</p>

<h4 id="application-health-checking">Application Health Checking</h4>

<p>然而，许多情况下，这种低级别的健康检查是不够的。</p>

<p>考虑下面的代码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>lockOne := sync.Mutex{}
lockTwo := sync.Mutex{}

go func() {
  lockOne.Lock();
  lockTwo.Lock();
  ...
}()

lockTwo.Lock();
lockOne.Lock();
</code></pre>
</div>

<p>这是计算机科学经典问题“死锁”的例子。
从 Docker 的角度来看进程仍然在运行，但是从应用程序的角度代码被死锁，永远不会再正确响应。</p>

<p>为解决这个问题，Kubernetes 支持应用层次的健康检查。
这些检查由 Kubelet 执行，确保应用程序运行的“正确性”。</p>

<p>目前有三种类型的应用健康检查可供选择：</p>

<ul>
  <li>HTTP 健康检查 - Kubelet 调用 web hook。如果返回 200-399 之间的状态码，则认为成功。反之则失败。</li>
  <li>Container Exec - Kubelet 在容器内执行命令。如果退出状态码为 0 则认为成功。</li>
  <li>TCP Socket - Kubelet 尝试向容器建立一个 socket。如果能建立成功，则任务是健康的，否则认为失败。</li>
</ul>

<p>任何情况，只要 Kubelet 发现容器故障，都会重启它。</p>

<p>容器健康检查在容器配置文件的 <code class="highlighter-rouge">livenessProbe</code> 部分配置。
还可以指定 <code class="highlighter-rouge">initialDelaySeconds</code>，即服务启动最初的一个宽限期，使容器执行必要的初始化后才执行健康检查。</p>

<p>以下是包含 HTTP 健康检查的示例：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apiVersion: v1
kind: Pod
metadata:
  name: pod-with-healthcheck
spec:
  containers:
  - name: nginx
    image: nginx
    # defines the health checking
    livenessProbe:
      # an http probe
      httpGet:
        path: /_status/healthz
        port: 80
      # length of time to wait for a pod to initialize
      # after pod startup, before applying health checking
      initialDelaySeconds: 30
      timeoutSeconds: 1
    ports:
    - containerPort: 80
</code></pre>
</div>

<p><a href="http://kubernetes.io/v1.0/docs/user-guide/pod-states.html#container-probes">Container Probes</a></p>

      </article>

      <hr class="masthead-hr">
      <div class="meta">
  
    <a class="basic-alignment left" href="http://blog.liulantao.com/blog/2015/2015-10-04-apache-tcp-backlog.html" title="Previous Post: Apache TCP Backlog 分析" data-instant>&laquo; Apache TCP Backlog 分析</a>
  
  
    <a class="basic-alignment right pull-right" href="http://blog.liulantao.com/blog/2016/2016-10-11-mesos-series-1-mesos-up.html" title="Next Post: Mesos 实战-1：Mesos 起步" data-instant>Mesos 实战-1：Mesos 起步 &raquo;</a>
  
</div>


      <hr class="masthead-hr">
      
<comments>

<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1936498"></script>
<!-- UY END -->

</comments>


    </div>

    <div class="col-sm-3">
      <nav id="toc" data-spy="affix" data-toggle="toc"></nav>
    </div>
  </div>

</div>

    </div>

    <!--
<a href="https://github.com/Lax/blog/"><img style="position: absolute; top: 0; right: 0; border: 0;" src="/images/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub!" /></a>
-->

<!-- Google Analytics -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1658815-3");
pageTracker._trackPageview();
</script>
<!-- Google Analytics end -->

<script type="application/ld+json">
{ "@context" : "http://schema.org",
  "@type" : "Person",
  "name" : "Liu Lantao",
  "url" : "http://blog.liulantao.com",
  "sameAs" : [
    "https://twitter.com/liulantao"
    "https://www.linkedin.com/in/liulantao",
    "https://www.google.com/+LiuLantao",
    "https://www.facebook.com/liu.lantao",
    "https://instagram.com/liulantao",
    "http://weibo.com/u/1653644220"
  ]
}
</script>


  </body>
</html><!--
environment: dotcom
build_revision: 4a071e293f2d0462c6a58130a77cf5309b263ddc
url: http://blog.liulantao.com/blog
jekyll : 3.3.1
jekyll-sass-converter : 1.3.0
kramdown : 1.11.1
liquid : 3.0.6
rouge : 1.11.1
github-pages-health-check : 1.3.0
jekyll-redirect-from : 0.11.0
jekyll-sitemap : 0.12.0
jekyll-feed : 0.8.0
jekyll-gist : 1.4.0
jekyll-paginate : 1.1.0
jekyll-coffeescript : 1.0.1
jekyll-seo-tag : 2.1.0
jekyll-github-metadata : 2.2.0
jekyll-avatar : 0.4.2
jemoji : 0.7.0
jekyll-mentions : 1.2.0
jekyll-relative-links : 0.2.1
jekyll-optional-front-matter : 0.1.2
jekyll-readme-index : 0.0.3
jekyll-default-layout : 0.1.4
jekyll-titles-from-headings : 0.1.3
listen : 3.0.6
activesupport : 4.2.7
minima : 2.0.0
jekyll-swiss : 0.4.0
jekyll-theme-primer : 0.1.5
jekyll-theme-architect : 0.0.3
jekyll-theme-cayman : 0.0.3
jekyll-theme-dinky : 0.0.3
jekyll-theme-hacker : 0.0.3
jekyll-theme-leap-day : 0.0.3
jekyll-theme-merlot : 0.0.3
jekyll-theme-midnight : 0.0.3
jekyll-theme-minimal : 0.0.3
jekyll-theme-modernist : 0.0.3
jekyll-theme-slate : 0.0.3
jekyll-theme-tactile : 0.0.3
jekyll-theme-time-machine : 0.0.3
ruby : 2.3.3
github-pages : 112
html-pipeline : 2.4.2
sass : 3.4.23
safe_yaml : 1.0.4
-->
