<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="nbadZjFSg9HTG-wGudhj-qFFFEAxOSpvhSkiQxYrsU4" />
    <title>[Weekly]Ruby2.1 GC改进;Bundler并行安装 | 刘兰涛的技术博客</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="">
    <meta name="keywords" content="系统运维, Ruby, iOS开发, Apple Swift Language Tutorial, Puppet, Jekyll, awk, CocoaPods">
    <link rel="author" href="https://plus.google.com/+LiuLantao">
    <link rel="shortcut icon" type="image/x-icon" href="http://blog.liulantao.com/favicon.ico">
    <link rel="canonical" href="http://blog.liulantao.com/blog/2013/2013-09-22-weekly-parallel-gem-installing-using-bundler.html">

    <link href="http://blog.liulantao.com/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="http://blog.liulantao.com/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>

    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Peek Poke</a>
    <a class="site-subtitle" href="/">刘兰涛的技术博客</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">

          <a class="page-link" href="/about/">About</a>

          <a class="page-link" href="/blog/archives/">Archive</a>

          <a class="page-link" href="/documents/">Documents</a>

          <a class="page-link" href="/links/">Links</a>

          <a class="page-link" href="/rubyrumors/">RubyRumors</a>

      </div>
    </nav>

  </div>

</header>

    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>[Weekly]Ruby2.1 GC改进;Bundler并行安装</h1>
    <p class="meta">Sep 22, 2013</p>
  </header>

  <article class="post-content">

<p>近期关注：</p>

<h4 id="ruby-21gc">ruby 2.1将对GC进行改进</h4>
<p>matz在baruco上宣布在ruby 2.1中将改进GC功能。这对于大规模部署ruby应用的企业来说，是个好消息。ruby官方版本（MRI）一直被人诟病，其中就包含GC方面的原因。而在此之前，大规模部署一般要借助于REE或者JRuby等第三方实现。</p>

<p>MRI和Rubinius的内存管理采用copy on write方式，亦即fork出的进程会与父进程共用一部分内存空间，除非对内存有改动。但是ruby进程进行GCd的方式是mark-and-sweep，导致对内存中的对象进行扫描及标记。首次进行GC时，copy on write的效果被抵消。</p>

<p>http://www.infoq.com/news/2013/09/ruby-2-1-gc-revamp</p>

<h4 id="bundlergems">Bundler开始支持并行安装gems</h4>
<p>从bundler~&gt;1.4.0开始，Bundler将可以通过-jN选项来指定并行度，并发安装gems。经本人测试，对于标准的rails应用，初次bundle安装的速度提升接近一倍。</p>

<p>测试过程</p>

<pre><code>rvm gemset delete bundler-j1
rvm gemset delete bundler-j8

rvm gemset use bundler-j1 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j1 &amp;&amp; cd rails-j1 &amp;&amp; time bundle install -j1
rvm gemset use bundler-j8 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j8 &amp;&amp; cd rails-j8 &amp;&amp; time bundle install -j8
</code></pre>

<p>结果(-j1):</p>

<pre><code>➜  ~    rvm gemset use bundler-j1 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j1 &amp;&amp; cd rails-j1 &amp;&amp; time bundle install -j1
Using ruby-head with gemset bundler-j1
Fetching: bundler-1.4.0.pre.2.gem (100%)
Successfully installed bundler-1.4.0.pre.2
Parsing documentation for bundler-1.4.0.pre.2
Installing ri documentation for bundler-1.4.0.pre.2
1 gem installed
Cloning into 'rails-j1'...
remote: Finding bitmap roots...
remote: Counting objects: 383508, done.
remote: Compressing objects: 100% (103485/103485), done.
remote: Total 383508 (delta 277740), reused 382388 (delta 276656)
Receiving objects: 100% (383508/383508), 94.56 MiB | 518 KiB/s, done.
Resolving deltas: 100% (277740/277740), done.
Fetching gem metadata from https://rubygems.org/.........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Using rake (10.1.0)
Installing i18n (0.6.5)
Installing json (1.8.0)
Installing minitest (5.0.8)
Installing atomic (1.1.14)
Installing thread_safe (0.1.3)
Installing tzinfo (0.3.37)
Using activesupport (4.1.0.beta) from source at .
Installing rack (1.5.2)
Installing rack-test (0.6.2)
Using actionpack (4.1.0.beta) from source at .
Installing builder (3.1.4)
Using activemodel (4.1.0.beta) from source at .
Installing erubis (2.7.0)
Using actionview (4.1.0.beta) from source at .
Installing mime-types (1.25)
Installing polyglot (0.3.3)
Installing treetop (1.4.15)
Installing mail (2.5.4)
Using actionmailer (4.1.0.beta) from source at .
Installing arel (4.0.0)
Using activerecord (4.1.0.beta) from source at .
Installing bcrypt-ruby (3.1.2)
Installing benchmark-ips (1.2.0)
Using bundler (1.4.0.pre.2)
Installing coffee-script-source (1.6.3)
Installing execjs (2.0.1)
Installing coffee-script (2.2.0)
Installing thor (0.18.1)
Using railties (4.1.0.beta) from source at .
Installing coffee-rails (4.0.0)
Installing dalli (2.6.4)
Installing hike (1.2.3)
Installing jquery-rails (2.2.2)
Installing mustache (0.99.4)
Installing mini_portile (0.5.1)
Installing nokogiri (1.6.0)
Installing kindlerb (0.1.1)
Installing metaclass (0.0.1)
Installing mocha (0.14.0)
Installing multi_json (1.8.0)
Installing mysql (2.9.1)
Installing mysql2 (0.3.13)
Installing pg (0.17.0)
Installing racc (1.4.9)
Installing rack-cache (1.2)
Installing tilt (1.4.1)
Installing sprockets (2.10.0)
Installing sprockets-rails (2.0.0)
Using rails (4.1.0.beta) from source at .
Installing rdoc (3.12.2)
Installing redcarpet (2.2.2)
Installing sdoc (0.3.20)
Installing sqlite3 (1.3.8)
Installing turbolinks (1.3.0)
Installing uglifier (2.2.1)
Installing w3c_validators (1.2)
Installing yajl-ruby (1.1.0)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
Post-install message from rdoc:
Depending on your version of ruby, you may need to install ruby rdoc/ri data:

&lt;= 1.8.6 : unsupported
 = 1.8.7 : gem install rdoc-data; rdoc-data --install
 = 1.9.1 : gem install rdoc-data; rdoc-data --install
&gt;= 1.9.2 : nothing to do! Yay!
bundle install -j1  76.48s user 22.49s system 34% cpu 4:49.31 total
</code></pre>

<p>结果(-j8):</p>

<pre><code>➜  ~    rvm gemset use bundler-j8 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j8 &amp;&amp; cd rails-j8 &amp;&amp; time bundle install -j8
Using ruby-head with gemset bundler-j8
Fetching: bundler-1.4.0.pre.2.gem (100%)
Successfully installed bundler-1.4.0.pre.2
Parsing documentation for bundler-1.4.0.pre.2
Installing ri documentation for bundler-1.4.0.pre.2
1 gem installed
Cloning into 'rails-j8'...
remote: Finding bitmap roots...
remote: Counting objects: 383508, done.
remote: Compressing objects: 100% (103485/103485), done.
remote: Total 383508 (delta 277740), reused 382388 (delta 276656)
Receiving objects: 100% (383508/383508), 94.56 MiB | 489 KiB/s, done.
Resolving deltas: 100% (277740/277740), done.
Fetching gem metadata from https://rubygems.org/.........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Installing builder (3.1.4)
Installing atomic (1.1.14)
Using rake (10.1.0)
Installing minitest (5.0.8)
Installing i18n (0.6.5)
Installing rack (1.5.2)
Installing polyglot (0.3.3)
Using bundler (1.4.0.pre.2)
Installing erubis (2.7.0)
Installing json (1.8.0)
Installing coffee-script-source (1.6.3)
Installing mime-types (1.25)
Installing benchmark-ips (1.2.0)
Installing arel (4.0.0)
Installing tzinfo (0.3.37)
Installing mustache (0.99.4)
Installing mini_portile (0.5.1)
Installing hike (1.2.3)
Installing execjs (2.0.1)
Installing multi_json (1.8.0)
Installing dalli (2.6.4)
Installing metaclass (0.0.1)
Installing bcrypt-ruby (3.1.2)
Installing thor (0.18.1)
Installing racc (1.4.9)
Installing tilt (1.4.1)
Installing mysql2 (0.3.13)
Installing mysql (2.9.1)
Installing thread_safe (0.1.3)
Installing redcarpet (2.2.2)
Installing rack-test (0.6.2)
Installing coffee-script (2.2.0)
Installing sqlite3 (1.3.8)
Installing rdoc (3.12.2)
Installing uglifier (2.2.1)
Installing treetop (1.4.15)
Installing rack-cache (1.2)
Using activesupport (4.1.0.beta) from source at .
Using actionpack (4.1.0.beta) from source at .
Using activemodel (4.1.0.beta) from source at .
Using railties (4.1.0.beta) from source at .
Using actionview (4.1.0.beta) from source at .
Using activerecord (4.1.0.beta) from source at .
Installing sprockets (2.10.0)
Installing yajl-ruby (1.1.0)
Installing mocha (0.14.0)
Installing pg (0.17.0)
Installing coffee-rails (4.0.0)
Installing jquery-rails (2.2.2)
Installing sprockets-rails (2.0.0)
Installing sdoc (0.3.20)
Installing turbolinks (1.3.0)
Installing mail (2.5.4)
Using actionmailer (4.1.0.beta) from source at .
Using rails (4.1.0.beta) from source at .
Installing nokogiri (1.6.0)
Installing kindlerb (0.1.1)
Installing w3c_validators (1.2)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
Post-install message from rdoc:
Depending on your version of ruby, you may need to install ruby rdoc/ri data:

&lt;= 1.8.6 : unsupported
= 1.8.7 : gem install rdoc-data; rdoc-data --install
= 1.9.1 : gem install rdoc-data; rdoc-data --install
&gt;= 1.9.2 : nothing to do! Yay!
bundle install -j8  77.96s user 22.92s system 59% cpu 2:49.20 total
</code></pre>

<p>从结果来看，CPU(user/system)时间变化不大，但是cpu利用率有明显提升，总消耗时间减少近一半。并发加快了总体安装的进程。</p>

<p>http://robots.thoughtbot.com/post/59584648154/parallel-gem-installing-using-bundler?utm_source=rubyweekly&amp;utm_medium=email</p>

  </article>

  <div class="meta">

    <a class="basic-alignment left" href="/blog/2013/2013-09-15-update-net-ssh-kerberos-for-ruby--191.html" title="Previous Post: Ruby-1.9.1之后版本支持kerberos问题的解决思路" data-instant>&laquo; Ruby-1.9.1之后版本支持kerberos问题的解决思路</a>

    <a class="basic-alignment right" href="/blog/2013/2013-09-23-kernel-uek-3813-upgrade-notes.html" title="Next Post: UEK R3升级手记" data-instant>UEK R3升级手记 &raquo;</a>

</div>
  <div id="related">
  <h2 class="subheader">Related Posts <small>They might be useful</small></h2>
  <ul class="posts">

      <li><span>18 Aug 2012</span> &raquo; <a href="http://blog.liulantao.com/blog/2012/2012-08-18-mac-osx-development-environment-setup.html">Mac OSX development environment setup</a></li>

      <li><span>25 Apr 2014</span> &raquo; <a href="http://blog.liulantao.com/blog/2014/2014-04-25-rubymotion-hello-world-app.html">5分钟开发iOS应用-使用RubyMotion</a></li>

      <li><span>12 May 2009</span> &raquo; <a href="http://blog.liulantao.com/blog/2009/2009-05-12-working-productively-in-bashs-vi.html">Working Productively in Bash’s Vi Command Line Editing Mode (with Cheat Sheet)</a></li>

  </ul>
</div>

<comments>

<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1936498"></script>
<!-- UY END -->

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'peekpoke'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</comments>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Peek Poke</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>刘兰涛的技术博客</li>
        <li>Liu Lantao</li>
        <li><a href="mailto:liulantao (at) gmail.com">liulantao (at) gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/Lax">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">Lax</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/liulantao">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">@liulantao</span>
          </a>
        </li>
        <li>
          <a href="https://plus.google.com/+LiuLantao">
            <span class="icon googleplus">
              <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                width="16px" height="16px" viewBox="0 0 134.658 131.646" enable-background="new 0 0 134.658 131.646"
                xml:space="preserve">
                <g>
                  <path fill="#C2C2C2" d="M126.515,4.109H8.144c-2.177,0-3.94,1.763-3.94,3.938v115.546c0,2.179,1.763,3.942,3.94,3.942h118.371
                  c2.177,0,3.94-1.764,3.94-3.942V8.048C130.455,5.872,128.691,4.109,126.515,4.109z"/>
                  <g>
                    <path fill="#FFFFFF" d="M70.479,71.845l-3.983-3.093c-1.213-1.006-2.872-2.334-2.872-4.765c0-2.441,1.659-3.993,3.099-5.43
                    c4.64-3.652,9.276-7.539,9.276-15.73c0-8.423-5.3-12.854-7.84-14.956h6.849l7.189-4.517H60.418
                    c-5.976,0-14.588,1.414-20.893,6.619c-4.752,4.1-7.07,9.753-7.07,14.842c0,8.639,6.633,17.396,18.346,17.396
                    c1.106,0,2.316-0.109,3.534-0.222c-0.547,1.331-1.1,2.439-1.1,4.32c0,3.431,1.763,5.535,3.317,7.528
                    c-4.977,0.342-14.268,0.893-21.117,5.103c-6.523,3.879-8.508,9.525-8.508,13.51c0,8.202,7.731,15.842,23.762,15.842
                    c19.01,0,29.074-10.519,29.074-20.932C79.764,79.709,75.344,75.943,70.479,71.845z M56,59.107
                    c-9.51,0-13.818-12.294-13.818-19.712c0-2.888,0.547-5.87,2.428-8.199c1.773-2.218,4.861-3.657,7.744-3.657
                    c9.168,0,13.923,12.404,13.923,20.382c0,1.996-0.22,5.533-2.762,8.09C61.737,57.785,58.762,59.107,56,59.107z M56.109,103.65
                    c-11.826,0-19.452-5.657-19.452-13.523c0-7.864,7.071-10.524,9.504-11.405c4.64-1.561,10.611-1.779,11.607-1.779
                    c1.105,0,1.658,0,2.538,0.111c8.407,5.983,12.056,8.965,12.056,14.629C72.362,98.542,66.723,103.65,56.109,103.65z"/>
                    <polygon fill="#FFFFFF" points="98.393,58.938 98.393,47.863 92.923,47.863 92.923,58.938 81.866,58.938 81.866,64.469
                    92.923,64.469 92.923,75.612 98.393,75.612 98.393,64.469 109.506,64.469 109.506,58.938"/>
                  </g>
                </g>
              </svg>
            </span>
            <span class="username">+LiuLantao</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">Idea, Code, Life 思考的点点滴滴</p>
    </div>

  </div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1658815-3', 'liulantao.com');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>

</footer>
<!--<script src="http://blog.liulantao.com/js/jquery.min.js" type="text/javascript"></script>-->

    </body>
</html>