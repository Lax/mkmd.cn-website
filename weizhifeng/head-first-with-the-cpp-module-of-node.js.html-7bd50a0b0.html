<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="apple-mobile-web-app-status-bar-style" content="black" />
   <!-- <link rel="apple-touch-icon" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone.png" /> -->
   <link rel="apple-touch-icon-precomposed" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone-precomposed.png" />
   <link rel="apple-touch-icon" sizes="72x72" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-ipad.png" />
   <link rel="apple-touch-icon" sizes="114x114" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone-retina.png" />
   <link rel="apple-touch-icon" sizes="144x144" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-ipad-retina.png" />
   
   <title>动手编写Node的C++模块</title>
   <meta name="author" content="Jeremy Wei" />
   <link href="http://feeds.feedburner.com/JeremyWei" rel="alternate" title="Jeremy Wei" type="application/atom+xml" />
   <link rel="shortcut icon" type="image/x-icon" href="http://s0-weizhifeng-net.b0.upaiyun.com/favicon.ico">
      
   <!-- Homepage CSS -->
   <link rel="stylesheet" href="http://s0-weizhifeng-net.b0.upaiyun.com/css/screen.css?1123" type="text/css" media="screen, projection" />
   <!-- <link rel="stylesheet" href="/css/screen.css?0831" type="text/css" media="screen, projection" /> -->
   
   <script type="text/javascript" charset="utf-8">
   // Mobile Safari in standalone mode
   if(("standalone" in window.navigator) && window.navigator.standalone){
	   
   	// If you want to prevent remote links in standalone web apps opening Mobile Safari, change 'remotes' to true
   	var noddy, remotes = true;
	
   	document.addEventListener('click', function(event) {
		
   		noddy = event.target;
		
   		// Bubble up until we hit link or top HTML element. Warning: BODY element is not compulsory so better to stop on HTML
   		while(noddy.nodeName !== "A" && noddy.nodeName !== "HTML") {
   	        noddy = noddy.parentNode;
   	    }
		
   		if('href' in noddy && noddy.href.indexOf('http') !== -1 && (noddy.href.indexOf(document.location.host) !== -1 || remotes))
   		{
   			event.preventDefault();
   			document.location.href = noddy.href;
   		}
	
   	},false);
   }
   </script>
</head>
<body>
	
<div class="site">
  <pre class="nav margin-for-mobile">["<a href='/tech.html'>文</a>", "<a href='/translate.html'>譯</a>", "<a href='/poem.html'>詩</a>", "<a href='/5000years.html'>史</a>", "<a href='/resume.html'>己</a>"]</pre>
  <br />
  <div id="post">
	<h1>动手编写Node的C++模块</h1>
	<div class="copyright">
	作者: JeremyWei | 可以转载, 但必须以超链接形式标明文章原始出处和作者信息及版权声明<br />
	网址: http://weizhifeng.net/head-first-with-the-cpp-module-of-node.js.html
	</div>

	<h1>介绍</h1>

<p>Node(或者Node.js)作为一门新兴的技术已经被越来越多的企业所使用，事件驱动的开发模式也为服务器端的开发注入了新的力量，Node很容易上手，只要你拥有JavaScript的基础和服务器端的开发经验。Node为开发者提供了两种方式来对其进行扩展：一种是通过JavaScript，一种是通过C/C++。在Node中使用JavaScript来编写模块是非常容易，也是最常用的方式，但是在一些场景中JavaScript的执行性能可能达不到要求（比如大量的位运算），不用发愁，Node还提供了C++的模块扩展接口，以提高执行的性能，本文就简要介绍下Node中C++模块的开发。</p>

<h1>目标</h1>

<p>本文我们创建一个名为<code>hello</code>的模块，其包含一个名为<code>sayHello</code>的方法，如果用JavaScript来表示的话，可能是这样：</p>

<pre><code>exports.sayHello = function() {
    return "Hello World!";
}
</code></pre>

<h1>概念</h1>

<p>Node的JavaScript引擎用的是Google开源的<a href="https://developers.google.com/v8/">V8</a> JavaScript引擎(Chrome浏览器所用的引擎)，所以简单介绍下v8中的一些概念：</p>

<ol>
<li>Handle：一个handle就是指向一个对象的指针。v8中所有的对象都是使用handle来进行访问，之所以用它是因为v8的垃圾回收器需要。</li>
<li>HandleScope：可以把它想象成是多个Handle的一个容器。</li>
</ol>


<p>除了v8之外，这里还要说明一下，用C++编写的模块和用JavaScript编写的模块在使用方式上并无区别，都是通过<code>require(...)</code>来进行调用，区别在于C++模块是系统编译好的二进制模块（在*nix下是<code>.so</code>，在win下是<code>dll</code>），并且扩展名为<code>.node</code>。在require<code>.node</code>模块的时候，系统通过<code>dlopen</code>函数来加载模块，不需要像JavaScript模块那样再进行编译，而是直接加载运行，这加快了执行的速度。</p>

<h1>编写</h1>

<p>首先创建模块需要的目录<code>src</code>和源文件<code>hello.cc</code></p>

<pre><code>$ mkdir -p hello/src &amp;&amp; cd hello/src
$ touch hello.cc
</code></pre>

<p>hello.cc的内容如下：</p>

<pre><code>#include &lt;node.h&gt;
#include &lt;v8.h&gt;

// 引入v8命名空间
using namespace v8;

// sayHello方法的具体逻辑
Handle&lt;Value&gt; Method(const Arguments&amp; args) {
    HandleScope scope;
    // 返回一个"Hello World!"字符串
    return scope.Close(String::New("Hello World!"));
}

// 初始化模块
void init(Handle&lt;Object&gt; target) {　
    // 定义模块中的sayHello方法
    NODE_SET_METHOD(target, "sayHello", Method);
}

// 定义"hello"模块
NODE_MODULE(hello, init);
</code></pre>

<p>以上就是模块的所有代码，还是比较容易理解的，其中的<code>NODE_SET_METHOD</code>和<code>NODE_MODULE</code>是node.h中定义的宏，具体如下：</p>

<p>Node模块的数据结构定义：</p>

<pre><code>struct node_module_struct {
  int version;
  void *dso_handle;
  const char *filename;
  node::addon_register_func register_func;
  node::addon_context_register_func register_context_func;
  const char *modname;
};
</code></pre>

<p><code>NODE_SET_METHOD</code>定义：</p>

<pre><code>template &lt;typename TypeName&gt;
inline void NODE_SET_METHOD(const TypeName&amp; recv,
                            const char* name,
                            v8::FunctionCallback callback) {
  v8::Isolate* isolate = v8::Isolate::GetCurrent();
  v8::HandleScope handle_scope(isolate);
  v8::Local&lt;v8::FunctionTemplate&gt; t = v8::FunctionTemplate::New(callback);
  v8::Local&lt;v8::Function&gt; fn = t-&gt;GetFunction();
  v8::Local&lt;v8::String&gt; fn_name = v8::String::NewFromUtf8(isolate, name);
  fn-&gt;SetName(fn_name);
  recv-&gt;Set(fn_name, fn);
}
</code></pre>

<p><code>NODE_MODULE</code>定义：</p>

<pre><code>#define NODE_MODULE(modname, regfunc)                                 \
  extern "C" {                                                        \
    NODE_MODULE_EXPORT node::node_module_struct modname ## _module =  \
    {                                                                 \
      NODE_STANDARD_MODULE_STUFF,                                     \
      (node::addon_register_func) (regfunc),                          \
      NULL,                                                           \
      NODE_STRINGIFY(modname)                                         \
    };                                                                \
  }
</code></pre>

<p>更加详细的内容，可以查看Node的<a href="https://github.com/joyent/node/blob/master/src/node.h">源码</a>。</p>

<h1>编译</h1>

<p>Node为了实现跨平台的编译，采用了Google的<a href="https://code.google.com/p/gyp/">GYP</a>(Generate Your Projects)来对项目进行管理。为了能够编译我们的项目，我们需要安装<code>node-gyp</code>：</p>

<pre><code>$ npm install -g node-gyp
</code></pre>

<p>安装完成之后，进入到源码目录，并且创建<code>binding.gyp</code>文件，因为<code>binding.gyp</code>是默认的项目定义文件。</p>

<pre><code>$ cd hello
$ touch binding.gyp
</code></pre>

<p>并且<code>binding.gyp</code>的内容为：</p>

<pre><code>{
  'targets': [
    {
      'target_name': 'hello',
      'sources': [
        'src/hello.cc'
      ],
      'dependencies': [
      ]
    }
  ]
}
</code></pre>

<p>之后我们以<code>binding.gyp</code>文件来生成<code>Makefile</code>等编译所需的文件：</p>

<pre><code>$ node-gyp configure
</code></pre>

<p>执行完成之后，在项目目录下会生成一个<code>build</code>目录，里边是gyp自动生成的一些编译所需文件。这一步完成之后，我们来进行编译操作：</p>

<pre><code>$ node-gyp build
</code></pre>

<p>如果执行没有问题的话，在<code>build/Release</code>目录下会生成<code>hello.node</code>文件，即我们创建的hello模块。</p>

<h1>运行</h1>

<p>模块编译成功之后，我们来测试测试模块的功能。在项目目录下创建一个<code>test.js</code>文件，内容如下：</p>

<pre><code>var hello = require('./build/Release/hello.node');
console.log(hello.sayHello());
</code></pre>

<p>执行此文件</p>

<pre><code>$ node test.js
$ Hello World!
</code></pre>

<h1>总结</h1>

<p>本文简要介绍了Node中C++模块的开发方式，v8中Handle和HandleScope的概念，以及gyp工具的使用，并实现了一个hello扩展模块。本文部分内容来自于<a href="http://book.douban.com/subject/25768396/">《深入浅出Node.js》</a>。</p>

<p>更多内容可以查看Node源码： <br/>
<a href="https://github.com/joyent/node/blob/master/src/node.h">https://github.com/joyent/node/blob/master/src/node.h</a> <br/>
<a href="https://github.com/joyent/node/blob/master/src/node.cc">https://github.com/joyent/node/blob/master/src/node.cc</a></p>

	(完)

	<div class="post-info">
		18 Jan 2014  
	
		
	
		
	</div>
	
	<!-- disqus start -->
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	    var disqus_shortname = 'jeremywei'; // required: replace example with your forum shortname

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<!-- disqus end -->

	<!-- related start -->
	<div id="related">
	  <h2>相关内容</h2>
	  <ul class="posts">
	    
	      <li><span>26 Jul 2014</span> &raquo; <a href="/learn-chef-02.html">Chef入门（二）</a></li>
	    
	      <li><span>19 Jul 2014</span> &raquo; <a href="/learn-chef-01.html">Chef入门（一）</a></li>
	    
	      <li><span>29 Jun 2014</span> &raquo; <a href="/backup-and-restore-data-of-mongodb.html">Mongodb数据的备份与恢复</a></li>
	    
	      <li><span>02 May 2014</span> &raquo; <a href="/build-private-npm-registry-with-npmjs-and-kappa.html">利用kappa搭建私有NPM仓库</a></li>
	    
	      <li><span>26 Apr 2014</span> &raquo; <a href="/how-to-publish-a-node-module.html">如何发布Node模块到NPM社区</a></li>
	    
	  </ul>
	</div>
	<!-- related end -->
</div>
  
<div class="footer"></div>
<div class="power">  
  Powered by <a href="http://github.com/" targe="_blank">Github</a> &nbsp;&amp;&amp;&nbsp; <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> 
</div>
</div>

<a href="http://github.com/jeremywei" target="_blank">
	<img class="right-banner first" src="http://s0-weizhifeng-net.b0.upaiyun.com/images/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" />
</a>

<a href="http://www.phptherightway.com" target="_blank">
    <img class="right-banner second" src="http://s0-weizhifeng-net.b0.upaiyun.com/images/php-the-right-way-120x60.png" alt="PHP: The Right Way"/>
</a>
</body>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5179718-7']);
  _gaq.push(['_setDomainName', 'weizhifeng.net']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</html>
