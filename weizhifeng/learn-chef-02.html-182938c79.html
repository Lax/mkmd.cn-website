<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="apple-mobile-web-app-status-bar-style" content="black" />
   <!-- <link rel="apple-touch-icon" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone.png" /> -->
   <link rel="apple-touch-icon-precomposed" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone-precomposed.png" />
   <link rel="apple-touch-icon" sizes="72x72" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-ipad.png" />
   <link rel="apple-touch-icon" sizes="114x114" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-iphone-retina.png" />
   <link rel="apple-touch-icon" sizes="144x144" href="http://s0-weizhifeng-net.b0.upaiyun.com/touch-icon-ipad-retina.png" />
   
   <title>Chef入门（二）</title>
   <meta name="author" content="Jeremy Wei" />
   <link href="http://feeds.feedburner.com/JeremyWei" rel="alternate" title="Jeremy Wei" type="application/atom+xml" />
   <link rel="shortcut icon" type="image/x-icon" href="http://s0-weizhifeng-net.b0.upaiyun.com/favicon.ico">
      
   <!-- Homepage CSS -->
   <link rel="stylesheet" href="http://s0-weizhifeng-net.b0.upaiyun.com/css/screen.css?1123" type="text/css" media="screen, projection" />
   <!-- <link rel="stylesheet" href="/css/screen.css?0831" type="text/css" media="screen, projection" /> -->
   
   <script type="text/javascript" charset="utf-8">
   // Mobile Safari in standalone mode
   if(("standalone" in window.navigator) && window.navigator.standalone){
	   
   	// If you want to prevent remote links in standalone web apps opening Mobile Safari, change 'remotes' to true
   	var noddy, remotes = true;
	
   	document.addEventListener('click', function(event) {
		
   		noddy = event.target;
		
   		// Bubble up until we hit link or top HTML element. Warning: BODY element is not compulsory so better to stop on HTML
   		while(noddy.nodeName !== "A" && noddy.nodeName !== "HTML") {
   	        noddy = noddy.parentNode;
   	    }
		
   		if('href' in noddy && noddy.href.indexOf('http') !== -1 && (noddy.href.indexOf(document.location.host) !== -1 || remotes))
   		{
   			event.preventDefault();
   			document.location.href = noddy.href;
   		}
	
   	},false);
   }
   </script>
</head>
<body>
	
<div class="site">
  <pre class="nav margin-for-mobile">["<a href='/tech.html'>文</a>", "<a href='/translate.html'>譯</a>", "<a href='/poem.html'>詩</a>", "<a href='/5000years.html'>史</a>", "<a href='/resume.html'>己</a>"]</pre>
  <br />
  <div id="post">
	<h1>Chef入门（二）</h1>
	<div class="copyright">
	作者: JeremyWei | 可以转载, 但必须以超链接形式标明文章原始出处和作者信息及版权声明<br />
	网址: http://weizhifeng.net/learn-chef-02.html
	</div>

	<p><img src="http://s0-weizhifeng-net.b0.upaiyun.com/images/tech/chef.png" title="Chef" alt="Chef" /></p>

<p>上一篇文章<a href="/learn-chef-01.html">Chef入门（一）</a>我们介绍了Chef是什么、以及如何搭建Chef环境。这篇文章，我们介绍一下Chef中的一些概念以及如何编写<a href="http://docs.getchef.com/chef_overview_cookbooks.html">cookbook</a>，并在此过程中部署一个Apache环境，通过本文你可以学到：</p>

<ul>
<li>创建一个cookbook，并在其中添加recipe</li>
<li>上传你的cookbook到Chef server</li>
<li>配置node的run list</li>
<li>在你的目标node上运行chef-client，执行cookbook中定义的操作。</li>
</ul>


<h1>一些概念</h1>

<h2>cookbook</h2>

<p>cookbook是配置和策略的集合单元，它定义了一个场景，比如部署Apache环境。一个cookbook包含了很多组件来支持实现这个场景，以下是一个cookbook的目录：</p>

<pre><code>-rw-r--r--  1 weizhifeng  staff   495 Jul 21 11:01 CHANGELOG.md
-rw-r--r--@ 1 weizhifeng  staff  1536 Jul 21 11:01 README.md
drwxr-xr-x  2 weizhifeng  staff    68 Jul 21 11:01 attributes
drwxr-xr-x  2 weizhifeng  staff    68 Jul 21 11:01 definitions
drwxr-xr-x  3 weizhifeng  staff   102 Jul 21 11:01 files
drwxr-xr-x  2 weizhifeng  staff    68 Jul 21 11:01 libraries
-rw-r--r--@ 1 weizhifeng  staff   298 Jul 21 11:01 metadata.rb
drwxr-xr-x  2 weizhifeng  staff    68 Jul 21 11:01 providers
drwxr-xr-x  3 weizhifeng  staff   102 Jul 26 11:05 recipes
drwxr-xr-x  2 weizhifeng  staff    68 Jul 21 11:01 resources
drwxr-xr-x  3 weizhifeng  staff   102 Jul 21 11:01 templates
</code></pre>

<ul>
<li>attributes：用来设置node的属性</li>
<li>definitions：用来创建可以重用的resource集合</li>
<li>files：一些需要的文件</li>
<li>libraries：用来扩展chef-client或者添加一些helper到Ruby中</li>
<li>metadata.rb：包含一些元数据，比如cookbook的名字、版本、支持的平台等等</li>
<li>recipes：存储recipe，每个recipe指定了需要的resource以及这些resource执行的顺序</li>
<li>resources：存储自定义的resource</li>
<li>providers：存储自定义的provider</li>
<li>templates：存储ruby模板语言描述的文件，用来解决复杂的配置场景</li>
</ul>


<h2>recipe</h2>

<p>每个cookbook都会包含一到多个recipe（默认是default.rb）。一个recipe就是实现cookbook所描述场景的步骤。看以下这个简单的recipe：</p>

<pre><code>package 'apache2' do
  action :install
end

service 'apache2' do
  action [ :enable, :start ]
end

cookbook_file '/var/www/index.html' do
  source 'index.html'
  mode '0644'
end
</code></pre>

<p>可以看出这个recipe分为三个步骤，分别是安装apache2、启动apache2、拷贝文件。</p>

<h2>resource和provider</h2>

<p><a href="http://docs.getchef.com/chef/resources.html">resource</a>就是recipe中的配置项，可以是package、service、bash等等。provider就是为这些resource提供实现的程序。以编程语言来描述的话，resource定义了接口，provider提供了不同平台的实现。</p>

<h1>实战</h1>

<p>说了那么多概念，我们接下来在ubuntu上安装并配置Apache。</p>

<h2>第一步：创建cookbook</h2>

<p>在workstation中，我们通过<a href="http://docs.opscode.com/knife.html">knife</a>来和Chef server进行交互。执行以下命令来创建一个cookbook。</p>

<pre><code>$ cd ~/chef-repo
$ knife cookbook create apache-tutorial-1
</code></pre>

<p>执行完成之后，在<code>~/chef-repo/cookbooks</code>目录下会生成名为<code>apache-tutorial-1</code>的cookbook。不过cookbook都是在本地的，还没有上传到Chef server。</p>

<h2>第二步：编写recipe</h2>

<p>当你创建了一个cookbook，Chef会帮你创建一个默认的recipe。用你的编辑器打开<code>~/chef-repo/cookbooks/apache-tutorial-1/recipes/default.rb</code>。现在让我们来写一些ruby代码来执行以下的动作：</p>

<ul>
<li>安装Apache</li>
<li>启动Apache并且添加到开机启动</li>
<li>配置home page</li>
</ul>


<p>把以下代码添加到recipe中。</p>

<pre><code>package 'apache2' do
  action :install
end

service 'apache2' do
  action [ :enable, :start ]
end

cookbook_file '/var/www/index.html' do
  source 'index.html'
  mode '0644'
end
</code></pre>

<h2>第三步：添加文件资源</h2>

<p>recipe的最后一步我们使用了<a href="http://docs.opscode.com/resource_cookbook_file.html">cookbook_file</a>来拷贝home page。把以下内容添加到文件<code>~/chef-repo/cookbooks/apache-tutorial-1/files/default/index.html</code>中。</p>

<pre><code>&lt;html&gt;
&lt;body&gt;
  &lt;h1&gt;Hello, world!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h2>第四步：上传cookbook</h2>

<p>在你的chef-repo目录中执行以下命令来上传cookbook。</p>

<pre><code>$ knife cookbook upload apache-tutorial-1
</code></pre>

<h2>第五步：创建run list</h2>

<p><a href="http://learn.getchef.com/concepts/run-lists/">run list</a>定义了recipe的执行顺序，当前的例子中我们的run list中只有一个recipe。打开<a href="http://manage.opscode.com">manage.opscode.com</a>，我们来配置run list。</p>

<p><img src="http://s0-weizhifeng-net.b0.upaiyun.com/images/tech/chef02-01.png" title="Chef" alt="Chef" /></p>

<p>然后从<code>Available Recipes</code>中拖拽recipe到<code>Current Run List</code>之中。然后点击<code>Save Run List</code>。</p>

<p><img src="http://s0-weizhifeng-net.b0.upaiyun.com/images/tech/chef02-02.png" title="Chef" alt="Chef" /></p>

<h2>第六步：运行chef-client</h2>

<p>接下来你需要执行<a href="http://docs.opscode.com/essentials_chef_client.html">chef-client</a>来从Chef server获取最新的cookbook，并且在目标node上执行。你可以自己登录到node上，然后手动执行。</p>

<pre><code>$ ssh chef@your.host
$ ssh sudo chef-client
</code></pre>

<p>或者使用knife。</p>

<pre><code>$ knife ssh your.host 'sudo chef-client' -m -x chef -P chef
</code></pre>

<p><code>-x</code>表示username，<code>-P</code>表示password。</p>

<p>如果你使用的是vagrant，则执行如下命令。</p>

<pre><code>$ knife ssh localhost 'sudo chef-client' -m -x vagrant -P vagrant --ssh-port 2200
Starting Chef Client, version 11.12.8
resolving cookbooks for run list: ["apache-tutorial-1"]
Synchronizing Cookbooks:
  - apache-tutorial-1
Compiling Cookbooks...
Converging 3 resources
Recipe: apache-tutorial-1::default
  * package[apache2] action install (up to date)
  * service[apache2] action enable (up to date)
  * service[apache2] action start (up to date)
  * cookbook_file[/var/www/index.html] action create (up to date)

Running handlers:
Running handlers complete

Chef Client finished, 0/4 resources updated in 19.554803129 seconds
</code></pre>

<p>等chef-client执行完成之后，你会发现Apache已经配置好并且运行了，并且把home page拷贝到了<code>/var/www/index.html</code>，访问80端口应该可以看到home page的输出。</p>

<p>至此我们已经创建了自己的cookbook，并在目标node上执行，更多的内容可以查看<a href="http://docs.opscode.com/">官方文档</a>。</p>

<h1>参考</h1>

<ul>
<li><a href="http://docs.getchef.com/chef_overview_cookbooks.html">http://docs.getchef.com/chef_overview_cookbooks.html</a></li>
<li><a href="http://learn.getchef.com/legacy/tutorials/create-your-first-cookbook/">http://learn.getchef.com/legacy/tutorials/create-your-first-cookbook/</a></li>
<li><a href="http://docs.getchef.com/chef/resources.html">http://docs.getchef.com/chef/resources.html</a></li>
</ul>


	(完)

	<div class="post-info">
		26 Jul 2014  
	
		
	
		
	</div>
	
	<!-- disqus start -->
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	    var disqus_shortname = 'jeremywei'; // required: replace example with your forum shortname

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	<!-- disqus end -->

	<!-- related start -->
	<div id="related">
	  <h2>相关内容</h2>
	  <ul class="posts">
	    
	      <li><span>19 Jul 2014</span> &raquo; <a href="/learn-chef-01.html">Chef入门（一）</a></li>
	    
	      <li><span>29 Jun 2014</span> &raquo; <a href="/backup-and-restore-data-of-mongodb.html">Mongodb数据的备份与恢复</a></li>
	    
	      <li><span>02 May 2014</span> &raquo; <a href="/build-private-npm-registry-with-npmjs-and-kappa.html">利用kappa搭建私有NPM仓库</a></li>
	    
	      <li><span>26 Apr 2014</span> &raquo; <a href="/how-to-publish-a-node-module.html">如何发布Node模块到NPM社区</a></li>
	    
	      <li><span>29 Mar 2014</span> &raquo; <a href="/node-version-management-via-n-and-nvm.html">利用n和nvm管理Node的版本</a></li>
	    
	  </ul>
	</div>
	<!-- related end -->
</div>
  
<div class="footer"></div>
<div class="power">  
  Powered by <a href="http://github.com/" targe="_blank">Github</a> &nbsp;&amp;&amp;&nbsp; <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> 
</div>
</div>

<a href="http://github.com/jeremywei" target="_blank">
	<img class="right-banner first" src="http://s0-weizhifeng-net.b0.upaiyun.com/images/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" />
</a>

<a href="http://www.phptherightway.com" target="_blank">
    <img class="right-banner second" src="http://s0-weizhifeng-net.b0.upaiyun.com/images/php-the-right-way-120x60.png" alt="PHP: The Right Way"/>
</a>
</body>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5179718-7']);
  _gaq.push(['_setDomainName', 'weizhifeng.net']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</html>
