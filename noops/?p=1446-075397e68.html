<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="js video maskImage placeholder" lang="zh-CN"><!--<![endif]-->
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">

     <title>ansible动手篇-如何书写自己的hosts脚本  |  NoOps</title>
    
    <script src="http://noops.me/wp-content/themes/darkstripes/javascripts/modernizr-2.0.js" type="text/javascript"></script>
    <script src="http://noops.me/wp-content/themes/darkstripes/javascripts/ender.js" type="text/javascript"></script>
    <script src="http://noops.me/wp-content/themes/darkstripes/javascripts/octopress.js" type="text/javascript"></script>

    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="http://noops.me/wp-content/themes/darkstripes/style.css" type="text/css" media="screen" />
    <link rel="pingback" href="http://noops.me/xmlrpc.php" />

    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

    <link rel="alternate" type="application/rss+xml" title="NoOps &raquo; ansible动手篇-如何书写自己的hosts脚本 评论 Feed" href="http://noops.me/?feed=rss2&#038;p=1446" />
<link rel='stylesheet' id='crayon_style-css'  href='http://noops.me/wp-content/plugins/crayon-syntax-highlighter/css/crayon_style.css?ver=2.1.2' type='text/css' media='all' />
<link rel='stylesheet' id='crayon_global_style-css'  href='http://noops.me/wp-content/plugins/crayon-syntax-highlighter/css/global_style.css?ver=2.1.2' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-github-css'  href='http://noops.me/wp-content/plugins/crayon-syntax-highlighter/themes/github/github.css?ver=2.1.2' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='http://noops.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=2.1.2' type='text/css' media='all' />
<script type='text/javascript' src='http://noops.me/wp-includes/js/jquery/jquery.js?ver=1.8.3'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"2.1.2","is_admin":"0","ajaxurl":"http:\/\/noops.me\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"\u4f7f\u7528 %s \u590d\u5236\uff0c\u4f7f\u7528 %s \u7c98\u8d34\u3002","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='http://noops.me/wp-content/plugins/crayon-syntax-highlighter/js/util.js?ver=2.1.2'></script>
<script type='text/javascript' src='http://noops.me/wp-content/plugins/crayon-syntax-highlighter/js/jquery.popup.js?ver=2.1.2'></script>
<script type='text/javascript' src='http://noops.me/wp-content/plugins/crayon-syntax-highlighter/js/crayon.js?ver=2.1.2'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://noops.me/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://noops.me/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='ansible来了' href='http://noops.me/?p=1420' />
<link rel='next' title='linux单机监控工具falcon-eye介绍' href='http://noops.me/?p=1471' />
<meta name="generator" content="WordPress 3.5.1" />
<link rel='canonical' href='http://noops.me/?p=1446' />

<!-- Start Of Script Generated By WP-PostViews -->
<script type="text/javascript">
/* <![CDATA[ */
jQuery.ajax({type:'GET',url:'http://noops.me/wp-admin/admin-ajax.php',data:'postviews_id=1446&action=postviews',cache:false});/* ]]> */
</script>
<!-- End Of Script Generated By WP-PostViews -->
	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
</head>

<body>
    <header role="banner">
        <hgroup>
            <h1>
                <a href="http://noops.me/" title="NoOps" rel="home">NoOps</a> 
            </h1>
            <h2 id="site-description">Ops make no ops | Ops的目标是没有Ops，嗯！</h2>
            <div class="clear"></div>
        </hgroup>
    </header>
    <nav role="navigation">
        <ul class="subscription" data-subscription="rss">
            <li><a href="/?feed=rss" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
        </ul>
        <form name="search" method="get" id="searchform" action="http://noops.me">
    <fieldset role="search">
        <input class="search" value="" results="0" name="s" id="s" placeholder="Search" />
    </fieldset>
</form>        <div class="main-navigation"><ul><li ><a href="http://noops.me/" title="首页">首页</a></li><li class="page_item page-item-2"><a href="http://noops.me/?page_id=2">About</a></li></ul></div>
    </nav>

<div id="main">
<div id="content">
    <div>

        
            <article class="hentry" role="article">

<header>
    <h1 class="entry-title">ansible动手篇-如何书写自己的hosts脚本</h1>
    <p>
        <span class="meta-prep meta-prep-author">作者： </span>
        <span class="author vcard"><a href="http://noops.me/?author=585" title="由 iambocai 发布" rel="author">iambocai</a></span>
        <span class="meta-sep"> | </span>
                    <span class="leave-reply" >&nbsp; 931 浏览 </span>
                <span class="meta-sep"> &nbsp;|&nbsp; </span>
        <time datetime="2014-03-18T14:50:52+0000" pubdate="" data-updated="true">
            2014/03/18 &nbsp;
            2:50 下午        </time>
        <span class="edit-link"></span>
    </p>
</header>

<div id="post-1446" class="post-1446 post type-post status-publish format-standard hentry category-python category-11 category-8 tag-ansible">
    <div class="entry-content">
                <div>
<h2><strong>写在前面</strong></h2>
</div>
<div>         最近Ansible很火，作为一个后起之秀，在github上他的commitor人数已经超过鼻祖puppet两倍多了，相信很多人也尝试过使用这款工具，如果你所管理的环境足够简单（模块没上50个？），足够变化足够慢（半年不用动？），那么也许你并不需要阅读本文，因为简单的静态配置就可以搞定你的需求了，请参考<a title="inventory介绍" href="http://docs.ansible.com/intro_inventory.html" target="_blank">官方文档</a>。</div>
<div></div>
<div>         更多的人遇到的是这样的情形：机器和分组信息需要从服务A中动态获取;资产信息需要从服务B中动态获取…诸如此类，但是我们运行时，往往需要以这些信息作为分组依据来管理。这时候，用静态hosts文件来管理就不现实了。幸运的是，ansible支持动态inventory script，不过官方对这部分的描述甚为模糊，甚至连返回的结构体应该是什么样子都没有提，造成很多同学只能望洋兴叹。本文就以我们自己写一个inventory script的过程，给大家分享下inventory 脚本的写法和要求。</div>
<div><span id="more-1446"></span></div>
<div>
<h2><strong>一、背景</strong></h2>
</div>
<div>         在我米，机器的属性是以tag来定义的，通过组合tag就可以唯一的确定一批具有相同属性的机器，这些属性包括但不限于产品划分，服务架构，机器硬件，流程状态，机器归属，控制部署等任何方面，这些tag由一个专门的系统（xbox）来维护和变更。</div>
<div>         举例来说，我如何找出一台属于小米公司米聊部门A产品线X服务fe（前端）子系统中m机房正在服务的nginx机器列表呢？我会通过类似如下一个tag串来查询它（仅作示例，司内莫要对号入座）：</div>
<blockquote>
<div>         com.xiaomi_dept.miliao_pdl.A_service.X.sbs.fe_idc.m_job.nginx_status.service</div>
</blockquote>
<div>         其中com，dept，pdl，service，sbs，job，status，分别是属性中公司，部门产品线，服务，子系统，原子服务，在线状态的tag标签。当我把这个串+token发给系统后，系统会找出在我权限范围内，包含所有这些标签，并且其对应属性值与tag串指明值相等的机器集合，于是我们得到了想要的机器列表。</div>
<div></div>
<div>
<h2><strong>二、与ansible的结合</strong></h2>
</div>
<div>         在考虑与ansible结合之前，搞清楚ansible本身如何获取、筛选机器列表并考虑与我们自己系统合适的对接是很有必要的，在开始时，我们只是以最粗暴直接的方式修改ansible源码，虽然快速的满足了需求，但也造成一个很严重的后果——给升级带来很大代价，因此最终我们放弃了这个版本。</div>
<div></div>
<div>
<h4><strong>1. 前期调研和规划</strong></h4>
</div>
<div>         首先我们来看下ansible是怎么调用到inventory脚本的，详细的列出追踪过程无论对作者还是读者都是一个极其痛苦的事情，因此我决定在这里只列出关键代码段：</div>
<div>
<!-- Crayon Syntax Highlighter v2.1.2 -->

		<div id="crayon-53c534042f7dd" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes" data-settings=" scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="height: 18px !important; line-height: 18px !important;"><span class="crayon-title">bin/ansible:run()</span>
			<div class="crayon-tools"><div class="crayon-button crayon-nums-button" title="切换显示行编号"></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"></div><div class="crayon-button crayon-expand-button" title="Expand Code"></div><div class="crayon-button crayon-copy-button" title="Expand Code"></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"></div><span class="crayon-language">Python</span></div></div>
			<div class="crayon-info" style="min-height: 15px !important; line-height: 15px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
    def run(self, options, args):
        ''' use Runner lib to do SSH things '''

        pattern = args[0]

        inventory_manager = inventory.Inventory(options.inventory)
        ……
        runner = Runner(
            module_name=options.module_name, module_path=options.module_path,
            module_args=options.module_args,
            remote_user=options.remote_user, remote_pass=sshpass,
            inventory=inventory_manager, timeout=options.timeout,
            private_key_file=options.private_key_file,
            forks=options.forks,
            pattern=pattern,
            callbacks=self.callbacks, sudo=options.sudo,
            sudo_pass=sudopass,sudo_user=options.sudo_user,
            transport=options.connection, subset=options.subset,
            check=options.check,
            diff=options.check,
            confirm=options.confirm
        )
        ……
        results = runner.run()
        return (runner, results)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-53c534042f7dd-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-2">2</div><div class="crayon-num" data-line="crayon-53c534042f7dd-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-4">4</div><div class="crayon-num" data-line="crayon-53c534042f7dd-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-6">6</div><div class="crayon-num" data-line="crayon-53c534042f7dd-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-8">8</div><div class="crayon-num" data-line="crayon-53c534042f7dd-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-10">10</div><div class="crayon-num" data-line="crayon-53c534042f7dd-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-12">12</div><div class="crayon-num" data-line="crayon-53c534042f7dd-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-14">14</div><div class="crayon-num" data-line="crayon-53c534042f7dd-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-16">16</div><div class="crayon-num" data-line="crayon-53c534042f7dd-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-18">18</div><div class="crayon-num" data-line="crayon-53c534042f7dd-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-20">20</div><div class="crayon-num" data-line="crayon-53c534042f7dd-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-22">22</div><div class="crayon-num" data-line="crayon-53c534042f7dd-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f7dd-24">24</div><div class="crayon-num" data-line="crayon-53c534042f7dd-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-line" id="crayon-53c534042f7dd-1"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">def</span><span class="h"> </span><span class="e">run</span><span class="sy">(</span><span class="r">self</span><span class="sy">,</span><span class="h"> </span><span class="i">options</span><span class="sy">,</span><span class="h"> </span><span class="i">args</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-2"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">''' use Runner lib to do SSH things '''</span></div><div class="crayon-line" id="crayon-53c534042f7dd-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-4"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">pattern</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">args</span><span class="sy">[</span><span class="cn">0</span><span class="sy">]</span></div><div class="crayon-line" id="crayon-53c534042f7dd-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-6"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">inventory_manager</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">inventory</span><span class="sy">.</span><span class="e">Inventory</span><span class="sy">(</span><span class="i">options</span><span class="sy">.</span><span class="v">inventory</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f7dd-7"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>……</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-8"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">runner</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">Runner</span><span class="sy">(</span></div><div class="crayon-line" id="crayon-53c534042f7dd-9"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">module_name</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">module_name</span><span class="sy">,</span><span class="h"> </span><span class="v">module_path</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">module_path</span><span class="sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-10"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">module_args</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">module_args</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f7dd-11"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">remote_user</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">remote_user</span><span class="sy">,</span><span class="h"> </span><span class="v">remote_pass</span><span class="o">=</span><span class="i">sshpass</span><span class="sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-12"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">inventory</span><span class="o">=</span><span class="i">inventory_manager</span><span class="sy">,</span><span class="h"> </span><span class="v">timeout</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">timeout</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f7dd-13"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">private_key_file</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">private_key_file</span><span class="sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-14"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">forks</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">forks</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f7dd-15"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">pattern</span><span class="o">=</span><span class="i">pattern</span><span class="sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-16"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">callbacks</span><span class="o">=</span><span class="r">self</span><span class="sy">.</span><span class="v">callbacks</span><span class="sy">,</span><span class="h"> </span><span class="v">sudo</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">sudo</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f7dd-17"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">sudo_pass</span><span class="o">=</span><span class="i">sudopass</span><span class="sy">,</span><span class="v">sudo_user</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">sudo_user</span><span class="sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-18"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">transport</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">connection</span><span class="sy">,</span><span class="h"> </span><span class="v">subset</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">subset</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f7dd-19"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">check</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">check</span><span class="sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-20"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">diff</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">check</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f7dd-21"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">confirm</span><span class="o">=</span><span class="i">options</span><span class="sy">.</span><span class="v">confirm</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-22"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f7dd-23"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>……</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f7dd-24"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">results</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">runner</span><span class="sy">.</span><span class="e">run</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f7dd-25"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">return</span><span class="h"> </span><span class="sy">(</span><span class="i">runner</span><span class="sy">,</span><span class="h"> </span><span class="i">results</span><span class="sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0067 seconds] -->
<br />
<!-- Crayon Syntax Highlighter v2.1.2 -->

		<div id="crayon-53c534042f88d" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes" data-settings=" scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="height: 18px !important; line-height: 18px !important;"><span class="crayon-title">lib/ansible/inventory/__init__.py</span>
			<div class="crayon-tools"><div class="crayon-button crayon-nums-button" title="切换显示行编号"></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"></div><div class="crayon-button crayon-expand-button" title="Expand Code"></div><div class="crayon-button crayon-copy-button" title="Expand Code"></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"></div><span class="crayon-language">Python</span></div></div>
			<div class="crayon-info" style="min-height: 15px !important; line-height: 15px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
class Inventory(object):
    """
    Host inventory for ansible.
    """
    def __init__(self, host_list=C.DEFAULT_HOST_LIST):

        # the host file file, or script path, or list of hosts
        # if a list, inventory data will NOT be loaded
        self.host_list = host_list
        ……
        if isinstance(host_list, basestring):
            if "," in host_list:
                host_list = host_list.split(",")
                host_list = [ h for h in host_list if h and h.strip() ]

        if host_list is None:
            self.parser = None
        elif isinstance(host_list, list):
            self.parser = None
            all = Group('all')
            self.groups = [ all ]
            ipv6_re = re.compile('\[([a-f:A-F0-9]*[%[0-z]+]?)\](?::(\d+))?')
            for x in host_list:
                m = ipv6_re.match(x)
                if m:
                    all.add_host(Host(m.groups()[0], m.groups()[1]))
                else:
                    if ":" in x:
                        tokens = x.rsplit(":", 1)
                        # if there is ':' in the address, then this is a ipv6
                        if ':' in tokens[0]:
                            all.add_host(Host(x))
                        else:
                            all.add_host(Host(tokens[0], tokens[1]))
                    else:
                        all.add_host(Host(x))
        elif os.path.exists(host_list):
            if os.path.isdir(host_list):
                # Ensure basedir is inside the directory
                self.host_list = os.path.join(self.host_list, "")
                self.parser = InventoryDirectory(filename=host_list)
                self.groups = self.parser.groups.values()
            elif utils.is_executable(host_list):
                self.parser = InventoryScript(filename=host_list)
                self.groups = self.parser.groups.values()
            else:
                self.parser = InventoryParser(filename=host_list)
                self.groups = self.parser.groups.values()

            utils.plugins.vars_loader.add_directory(self.basedir(), with_subdir=True)
        else:
            raise errors.AnsibleError("Unable to find an inventory file, specify one with -i ?")
        ……</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-53c534042f88d-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-2">2</div><div class="crayon-num" data-line="crayon-53c534042f88d-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-4">4</div><div class="crayon-num" data-line="crayon-53c534042f88d-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-6">6</div><div class="crayon-num" data-line="crayon-53c534042f88d-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-8">8</div><div class="crayon-num" data-line="crayon-53c534042f88d-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-10">10</div><div class="crayon-num" data-line="crayon-53c534042f88d-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-12">12</div><div class="crayon-num" data-line="crayon-53c534042f88d-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-14">14</div><div class="crayon-num" data-line="crayon-53c534042f88d-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-16">16</div><div class="crayon-num" data-line="crayon-53c534042f88d-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-18">18</div><div class="crayon-num" data-line="crayon-53c534042f88d-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-20">20</div><div class="crayon-num" data-line="crayon-53c534042f88d-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-22">22</div><div class="crayon-num" data-line="crayon-53c534042f88d-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-24">24</div><div class="crayon-num" data-line="crayon-53c534042f88d-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-26">26</div><div class="crayon-num" data-line="crayon-53c534042f88d-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-28">28</div><div class="crayon-num" data-line="crayon-53c534042f88d-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-30">30</div><div class="crayon-num" data-line="crayon-53c534042f88d-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-32">32</div><div class="crayon-num" data-line="crayon-53c534042f88d-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-34">34</div><div class="crayon-num" data-line="crayon-53c534042f88d-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-36">36</div><div class="crayon-num" data-line="crayon-53c534042f88d-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-38">38</div><div class="crayon-num" data-line="crayon-53c534042f88d-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-40">40</div><div class="crayon-num" data-line="crayon-53c534042f88d-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-42">42</div><div class="crayon-num" data-line="crayon-53c534042f88d-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-44">44</div><div class="crayon-num" data-line="crayon-53c534042f88d-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-46">46</div><div class="crayon-num" data-line="crayon-53c534042f88d-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-48">48</div><div class="crayon-num" data-line="crayon-53c534042f88d-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-50">50</div><div class="crayon-num" data-line="crayon-53c534042f88d-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f88d-52">52</div><div class="crayon-num" data-line="crayon-53c534042f88d-53">53</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-line" id="crayon-53c534042f88d-1"><span class="t">class</span><span class="h"> </span><span class="e">Inventory</span><span class="sy">(</span><span class="k ">object</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-2"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"""</span></div><div class="crayon-line" id="crayon-53c534042f88d-3"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;Host inventory for ansible.</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-4"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;"""</span></div><div class="crayon-line" id="crayon-53c534042f88d-5"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">def</span><span class="h"> </span><span class="e">__init__</span><span class="sy">(</span><span class="r">self</span><span class="sy">,</span><span class="h"> </span><span class="v">host_list</span><span class="o">=</span><span class="i">C</span><span class="sy">.</span><span class="v">DEFAULT_HOST_LIST</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-6">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f88d-7"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c"># the host file file, or script path, or list of hosts</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-8"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c"># if a list, inventory data will NOT be loaded</span></div><div class="crayon-line" id="crayon-53c534042f88d-9"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">host_list</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">host_list</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-10"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>……</div><div class="crayon-line" id="crayon-53c534042f88d-11"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="k ">isinstance</span><span class="sy">(</span><span class="i">host_list</span><span class="sy">,</span><span class="h"> </span><span class="k ">basestring</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-12"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="s">","</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">host_list</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f88d-13"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">host_list</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">host_list</span><span class="sy">.</span><span class="e">split</span><span class="sy">(</span><span class="s">","</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-14"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">host_list</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="sy">[</span><span class="h"> </span><span class="i">h</span><span class="h"> </span><span class="st">for</span><span class="h"> </span><span class="i">h</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="e">host_list </span><span class="st">if</span><span class="h"> </span><span class="i">h</span><span class="h"> </span><span class="st">and</span><span class="h"> </span><span class="i">h</span><span class="sy">.</span><span class="e">strip</span><span class="sy">(</span><span class="sy">)</span><span class="h"> </span><span class="sy">]</span></div><div class="crayon-line" id="crayon-53c534042f88d-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-16"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="e">host_list </span><span class="st">is</span><span class="h"> </span><span class="t">None</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f88d-17"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="k ">parser</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="t">None</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-18"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">elif</span><span class="h"> </span><span class="k ">isinstance</span><span class="sy">(</span><span class="i">host_list</span><span class="sy">,</span><span class="h"> </span><span class="k ">list</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f88d-19"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="k ">parser</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="t">None</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-20"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="k ">all</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">Group</span><span class="sy">(</span><span class="s">'all'</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-21"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">groups</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="sy">[</span><span class="h"> </span><span class="k ">all</span><span class="h"> </span><span class="sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-22"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">ipv6_re</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="k ">re</span><span class="sy">.</span><span class="k ">compile</span><span class="sy">(</span><span class="s">'\[([a-f:A-F0-9]*[%[0-z]+]?)\](?::(\d+))?'</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-23"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="i">x</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">host_list</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-24"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">m</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">ipv6_re</span><span class="sy">.</span><span class="e">match</span><span class="sy">(</span><span class="i">x</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-25"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="i">m</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-26"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="k ">all</span><span class="sy">.</span><span class="e">add_host</span><span class="sy">(</span><span class="e">Host</span><span class="sy">(</span><span class="i">m</span><span class="sy">.</span><span class="e">groups</span><span class="sy">(</span><span class="sy">)</span><span class="sy">[</span><span class="cn">0</span><span class="sy">]</span><span class="sy">,</span><span class="h"> </span><span class="i">m</span><span class="sy">.</span><span class="e">groups</span><span class="sy">(</span><span class="sy">)</span><span class="sy">[</span><span class="cn">1</span><span class="sy">]</span><span class="sy">)</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-27"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">else</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-28"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="s">":"</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">x</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f88d-29"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">tokens</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">x</span><span class="sy">.</span><span class="e">rsplit</span><span class="sy">(</span><span class="s">":"</span><span class="sy">,</span><span class="h"> </span><span class="cn">1</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-30"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c"># if there is ':' in the address, then this is a ipv6</span></div><div class="crayon-line" id="crayon-53c534042f88d-31"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="s">':'</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">tokens</span><span class="sy">[</span><span class="cn">0</span><span class="sy">]</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-32"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="k ">all</span><span class="sy">.</span><span class="e">add_host</span><span class="sy">(</span><span class="e">Host</span><span class="sy">(</span><span class="i">x</span><span class="sy">)</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-33"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">else</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-34"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="k ">all</span><span class="sy">.</span><span class="e">add_host</span><span class="sy">(</span><span class="e">Host</span><span class="sy">(</span><span class="i">tokens</span><span class="sy">[</span><span class="cn">0</span><span class="sy">]</span><span class="sy">,</span><span class="h"> </span><span class="i">tokens</span><span class="sy">[</span><span class="cn">1</span><span class="sy">]</span><span class="sy">)</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-35"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">else</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-36"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="k ">all</span><span class="sy">.</span><span class="e">add_host</span><span class="sy">(</span><span class="e">Host</span><span class="sy">(</span><span class="i">x</span><span class="sy">)</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-37"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">elif</span><span class="h"> </span><span class="k ">os.path</span><span class="sy">.</span><span class="e">exists</span><span class="sy">(</span><span class="i">host_list</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-38"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="k ">os.path</span><span class="sy">.</span><span class="e">isdir</span><span class="sy">(</span><span class="i">host_list</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f88d-39"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c"># Ensure basedir is inside the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-40"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">host_list</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="k ">os.path</span><span class="sy">.</span><span class="e">join</span><span class="sy">(</span><span class="r">self</span><span class="sy">.</span><span class="v">host_list</span><span class="sy">,</span><span class="h"> </span><span class="s">""</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-41"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="k ">parser</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">InventoryDirectory</span><span class="sy">(</span><span class="v">filename</span><span class="o">=</span><span class="i">host_list</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-42"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">groups</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="k ">parser</span><span class="sy">.</span><span class="v">groups</span><span class="sy">.</span><span class="e">values</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-43"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">elif</span><span class="h"> </span><span class="i">utils</span><span class="sy">.</span><span class="e">is_executable</span><span class="sy">(</span><span class="i">host_list</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-44"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="k ">parser</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">InventoryScript</span><span class="sy">(</span><span class="v">filename</span><span class="o">=</span><span class="i">host_list</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-45"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">groups</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="k ">parser</span><span class="sy">.</span><span class="v">groups</span><span class="sy">.</span><span class="e">values</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-46"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">else</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f88d-47"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="k ">parser</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">InventoryParser</span><span class="sy">(</span><span class="v">filename</span><span class="o">=</span><span class="i">host_list</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-48"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">groups</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="k ">parser</span><span class="sy">.</span><span class="v">groups</span><span class="sy">.</span><span class="e">values</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-49">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-50"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">utils</span><span class="sy">.</span><span class="v">plugins</span><span class="sy">.</span><span class="v">vars_loader</span><span class="sy">.</span><span class="e">add_directory</span><span class="sy">(</span><span class="r">self</span><span class="sy">.</span><span class="e">basedir</span><span class="sy">(</span><span class="sy">)</span><span class="sy">,</span><span class="h"> </span><span class="v">with_subdir</span><span class="o">=</span><span class="t">True</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-51"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">else</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f88d-52"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">raise</span><span class="h"> </span><span class="i">errors</span><span class="sy">.</span><span class="e">AnsibleError</span><span class="sy">(</span><span class="s">"Unable to find an inventory file, specify one with -i ?"</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f88d-53"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>……</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0171 seconds] -->
<br />
<!-- Crayon Syntax Highlighter v2.1.2 -->

		<div id="crayon-53c534042f940" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes" data-settings=" scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="height: 18px !important; line-height: 18px !important;"><span class="crayon-title">lib/ansible/inventory/script.py</span>
			<div class="crayon-tools"><div class="crayon-button crayon-nums-button" title="切换显示行编号"></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"></div><div class="crayon-button crayon-expand-button" title="Expand Code"></div><div class="crayon-button crayon-copy-button" title="Expand Code"></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"></div></div></div>
			<div class="crayon-info" style="min-height: 15px !important; line-height: 15px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
class InventoryScript(object):
    ''' Host inventory parser for ansible using external inventory scripts. '''

    def __init__(self, filename=C.DEFAULT_HOST_LIST):

        # Support inventory scripts that are not prefixed with some
        # path information but happen to be in the current working
        # directory when '.' is not in PATH.
        self.filename = os.path.abspath(filename)
        cmd = [ self.filename, "--list" ]
        try:
            sp = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        except OSError, e:
            raise errors.AnsibleError("problem running %s (%s)" % (' '.join(cmd), e))
        (stdout, stderr) = sp.communicate()
        self.data = stdout
        # see comment about _meta below
        self.host_vars_from_top = None
        self.groups = self._parse(stderr)

    def _parse(self, err):

        all_hosts = {}
        self.raw  = utils.parse_json(self.data)
        all       = Group('all')
        groups    = dict(all=all)
        group     = None

        if 'failed' in self.raw:
            sys.stderr.write(err + "\n")
            raise errors.AnsibleError("failed to parse executable inventory script results: %s" % self.raw)

        for (group_name, data) in self.raw.items():

            # in Ansible 1.3 and later, a "_meta" subelement may contain
            # a variable "hostvars" which contains a hash for each host
            # if this "hostvars" exists at all then do not call --host for each
            # host.  This is for efficiency and scripts should still return data
            # if called with --host for backwards compat with 1.2 and earlier.

            if group_name == '_meta':
                if 'hostvars' in data:
                    self.host_vars_from_top = data['hostvars']
                    continue

            if group_name != all.name:
                group = groups[group_name] = Group(group_name)
            else:
                group = all
            host = None

            if not isinstance(data, dict):
                data = {'hosts': data}
            elif not any(k in data for k in ('hosts','vars')):
                data = {'hosts': [group_name], 'vars': data}

            if 'hosts' in data:

                for hostname in data['hosts']:
                    # filter out hosts not in user's permission
                    if hostname not in C.DEFAULT_HOST_LIST:
                        continue
                    if not hostname in all_hosts:
                        all_hosts[hostname] = Host(hostname)
                    host = all_hosts[hostname]
                    group.add_host(host)

            if 'vars' in data:
                for k, v in data['vars'].iteritems():
                    if group.name == all.name:
                        all.set_variable(k, v)
                    else:
                        group.set_variable(k, v)
            if group.name != all.name:
                all.add_child_group(group)

        # Separate loop to ensure all groups are defined
        for (group_name, data) in self.raw.items():
            if group_name == '_meta':
                continue
            if isinstance(data, dict) and 'children' in data:
                for child_name in data['children']:
                    if child_name in groups:
                        groups[group_name].add_child_group(groups[child_name])
        return groups

    def get_host_variables(self, host):
        """ Runs &lt;script&gt; --host &lt;hostname&gt; to determine additional host variables """
        if self.host_vars_from_top is not None:
            got = self.host_vars_from_top.get(host.name, {})
            return got

        cmd = [self.filename, "--host", host.name]
        try:
            sp = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        except OSError, e:
            raise errors.AnsibleError("problem running %s (%s)" % (' '.join(cmd), e))
        (out, err) = sp.communicate()
        return utils.parse_json(out)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-53c534042f940-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-2">2</div><div class="crayon-num" data-line="crayon-53c534042f940-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-4">4</div><div class="crayon-num" data-line="crayon-53c534042f940-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-6">6</div><div class="crayon-num" data-line="crayon-53c534042f940-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-8">8</div><div class="crayon-num" data-line="crayon-53c534042f940-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-10">10</div><div class="crayon-num" data-line="crayon-53c534042f940-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-12">12</div><div class="crayon-num" data-line="crayon-53c534042f940-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-14">14</div><div class="crayon-num" data-line="crayon-53c534042f940-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-16">16</div><div class="crayon-num" data-line="crayon-53c534042f940-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-18">18</div><div class="crayon-num" data-line="crayon-53c534042f940-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-20">20</div><div class="crayon-num" data-line="crayon-53c534042f940-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-22">22</div><div class="crayon-num" data-line="crayon-53c534042f940-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-24">24</div><div class="crayon-num" data-line="crayon-53c534042f940-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-26">26</div><div class="crayon-num" data-line="crayon-53c534042f940-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-28">28</div><div class="crayon-num" data-line="crayon-53c534042f940-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-30">30</div><div class="crayon-num" data-line="crayon-53c534042f940-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-32">32</div><div class="crayon-num" data-line="crayon-53c534042f940-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-34">34</div><div class="crayon-num" data-line="crayon-53c534042f940-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-36">36</div><div class="crayon-num" data-line="crayon-53c534042f940-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-38">38</div><div class="crayon-num" data-line="crayon-53c534042f940-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-40">40</div><div class="crayon-num" data-line="crayon-53c534042f940-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-42">42</div><div class="crayon-num" data-line="crayon-53c534042f940-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-44">44</div><div class="crayon-num" data-line="crayon-53c534042f940-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-46">46</div><div class="crayon-num" data-line="crayon-53c534042f940-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-48">48</div><div class="crayon-num" data-line="crayon-53c534042f940-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-50">50</div><div class="crayon-num" data-line="crayon-53c534042f940-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-52">52</div><div class="crayon-num" data-line="crayon-53c534042f940-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-54">54</div><div class="crayon-num" data-line="crayon-53c534042f940-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-56">56</div><div class="crayon-num" data-line="crayon-53c534042f940-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-58">58</div><div class="crayon-num" data-line="crayon-53c534042f940-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-60">60</div><div class="crayon-num" data-line="crayon-53c534042f940-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-62">62</div><div class="crayon-num" data-line="crayon-53c534042f940-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-64">64</div><div class="crayon-num" data-line="crayon-53c534042f940-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-66">66</div><div class="crayon-num" data-line="crayon-53c534042f940-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-68">68</div><div class="crayon-num" data-line="crayon-53c534042f940-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-70">70</div><div class="crayon-num" data-line="crayon-53c534042f940-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-72">72</div><div class="crayon-num" data-line="crayon-53c534042f940-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-74">74</div><div class="crayon-num" data-line="crayon-53c534042f940-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-76">76</div><div class="crayon-num" data-line="crayon-53c534042f940-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-78">78</div><div class="crayon-num" data-line="crayon-53c534042f940-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-80">80</div><div class="crayon-num" data-line="crayon-53c534042f940-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-82">82</div><div class="crayon-num" data-line="crayon-53c534042f940-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-84">84</div><div class="crayon-num" data-line="crayon-53c534042f940-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-86">86</div><div class="crayon-num" data-line="crayon-53c534042f940-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-88">88</div><div class="crayon-num" data-line="crayon-53c534042f940-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-90">90</div><div class="crayon-num" data-line="crayon-53c534042f940-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-92">92</div><div class="crayon-num" data-line="crayon-53c534042f940-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-94">94</div><div class="crayon-num" data-line="crayon-53c534042f940-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-96">96</div><div class="crayon-num" data-line="crayon-53c534042f940-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f940-98">98</div><div class="crayon-num" data-line="crayon-53c534042f940-99">99</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-line" id="crayon-53c534042f940-1"><span class="t">class</span><span class="h"> </span><span class="e">InventoryScript</span><span class="sy">(</span><span class="t">object</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-2"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">''</span><span class="s">' Host inventory parser for ansible using external inventory scripts. '</span><span class="s">''</span></div><div class="crayon-line" id="crayon-53c534042f940-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-4"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">def </span><span class="e">__init__</span><span class="sy">(</span><span class="r">self</span><span class="sy">,</span><span class="h"> </span><span class="v">filename</span><span class="o">=</span><span class="i">C</span><span class="sy">.</span><span class="v">DEFAULT_HOST_LIST</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-6"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># Support inventory scripts that are not prefixed with some</span></div><div class="crayon-line" id="crayon-53c534042f940-7"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># path information but happen to be in the current working</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-8"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># directory when '.' is not in PATH.</span></div><div class="crayon-line" id="crayon-53c534042f940-9"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">filename</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">os</span><span class="sy">.</span><span class="v">path</span><span class="sy">.</span><span class="e">abspath</span><span class="sy">(</span><span class="i">filename</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-10"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">cmd</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="sy">[</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="v">filename</span><span class="sy">,</span><span class="h"> </span><span class="s">"--list"</span><span class="h"> </span><span class="sy">]</span></div><div class="crayon-line" id="crayon-53c534042f940-11"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">try</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-12"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">sp</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">subprocess</span><span class="sy">.</span><span class="e">Popen</span><span class="sy">(</span><span class="i">cmd</span><span class="sy">,</span><span class="h"> </span><span class="v">stdout</span><span class="o">=</span><span class="i">subprocess</span><span class="sy">.</span><span class="v">PIPE</span><span class="sy">,</span><span class="h"> </span><span class="v">stderr</span><span class="o">=</span><span class="i">subprocess</span><span class="sy">.</span><span class="v">PIPE</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-13"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">except </span><span class="i">OSError</span><span class="sy">,</span><span class="h"> </span><span class="i">e</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-14"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">raise </span><span class="i">errors</span><span class="sy">.</span><span class="e">AnsibleError</span><span class="sy">(</span><span class="s">"problem running %s (%s)"</span><span class="h"> </span><span class="o">%</span><span class="h"> </span><span class="sy">(</span><span class="s">' '</span><span class="sy">.</span><span class="e">join</span><span class="sy">(</span><span class="i">cmd</span><span class="sy">)</span><span class="sy">,</span><span class="h"> </span><span class="i">e</span><span class="sy">)</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-15"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">(</span><span class="i">stdout</span><span class="sy">,</span><span class="h"> </span><span class="i">stderr</span><span class="sy">)</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">sp</span><span class="sy">.</span><span class="e">communicate</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-16"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">data</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">stdout</span></div><div class="crayon-line" id="crayon-53c534042f940-17"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># see comment about _meta below</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-18"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">host_vars_from_top</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">None</span></div><div class="crayon-line" id="crayon-53c534042f940-19"><span class="e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">groups</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="e">_parse</span><span class="sy">(</span><span class="i">stderr</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-20">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-21"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">def </span><span class="e">_parse</span><span class="sy">(</span><span class="r">self</span><span class="sy">,</span><span class="h"> </span><span class="i">err</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-22">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-23"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">all_hosts</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="sy">{</span><span class="sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-24"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">raw</span><span class="h">&nbsp;&nbsp;</span><span class="o">=</span><span class="h"> </span><span class="i">utils</span><span class="sy">.</span><span class="e">parse_json</span><span class="sy">(</span><span class="r">self</span><span class="sy">.</span><span class="v">data</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-25"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">all</span><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="o">=</span><span class="h"> </span><span class="e">Group</span><span class="sy">(</span><span class="s">'all'</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-26"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">groups</span><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">=</span><span class="h"> </span><span class="e">dict</span><span class="sy">(</span><span class="v">all</span><span class="o">=</span><span class="i">all</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-27"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">group</span><span class="h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="o">=</span><span class="h"> </span><span class="e">None</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-28">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-29"><span class="e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="s">'failed'</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="v">raw</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-30"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">sys</span><span class="sy">.</span><span class="v">stderr</span><span class="sy">.</span><span class="e">write</span><span class="sy">(</span><span class="i">err</span><span class="h"> </span><span class="o">+</span><span class="h"> </span><span class="s">"\n"</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-31"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">raise </span><span class="i">errors</span><span class="sy">.</span><span class="e">AnsibleError</span><span class="sy">(</span><span class="s">"failed to parse executable inventory script results: %s"</span><span class="h"> </span><span class="o">%</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="v">raw</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-32">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-33"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="sy">(</span><span class="i">group_name</span><span class="sy">,</span><span class="h"> </span><span class="i">data</span><span class="sy">)</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="v">raw</span><span class="sy">.</span><span class="e">items</span><span class="sy">(</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-34">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-35"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># in Ansible 1.3 and later, a "_meta" subelement may contain</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-36"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># a variable "hostvars" which contains a hash for each host</span></div><div class="crayon-line" id="crayon-53c534042f940-37"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># if this "hostvars" exists at all then do not call --host for each</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-38"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># host.&nbsp;&nbsp;This is for efficiency and scripts should still return data</span></div><div class="crayon-line" id="crayon-53c534042f940-39"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># if called with --host for backwards compat with 1.2 and earlier.</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-40">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-41"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="v">group_name</span><span class="h"> </span><span class="o">==</span><span class="h"> </span><span class="s">'_meta'</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-42"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="s">'hostvars'</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">data</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-43"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">host_vars_from_top</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">data</span><span class="sy">[</span><span class="s">'hostvars'</span><span class="sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-44"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">continue</span></div><div class="crayon-line" id="crayon-53c534042f940-45">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-46"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="i">group_name</span><span class="h"> </span><span class="o">!=</span><span class="h"> </span><span class="i">all</span><span class="sy">.</span><span class="v">name</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-47"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">group</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">groups</span><span class="sy">[</span><span class="i">group_name</span><span class="sy">]</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">Group</span><span class="sy">(</span><span class="i">group_name</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-48"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">else</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-49"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">group</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">all</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-50"><span class="e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">host</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">None</span></div><div class="crayon-line" id="crayon-53c534042f940-51">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-52"><span class="e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="st">not</span><span class="h"> </span><span class="e">isinstance</span><span class="sy">(</span><span class="i">data</span><span class="sy">,</span><span class="h"> </span><span class="i">dict</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-53"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">data</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="sy">{</span><span class="s">'hosts'</span><span class="o">:</span><span class="h"> </span><span class="i">data</span><span class="sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-54"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">elif </span><span class="st">not</span><span class="h"> </span><span class="e">any</span><span class="sy">(</span><span class="i">k</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="e">data </span><span class="st">for</span><span class="h"> </span><span class="i">k</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="sy">(</span><span class="s">'hosts'</span><span class="sy">,</span><span class="s">'vars'</span><span class="sy">)</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-55"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">data</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="sy">{</span><span class="s">'hosts'</span><span class="o">:</span><span class="h"> </span><span class="sy">[</span><span class="i">group_name</span><span class="sy">]</span><span class="sy">,</span><span class="h"> </span><span class="s">'vars'</span><span class="o">:</span><span class="h"> </span><span class="i">data</span><span class="sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-56">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-57"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="s">'hosts'</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">data</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-58">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-59"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="e">hostname </span><span class="st">in</span><span class="h"> </span><span class="i">data</span><span class="sy">[</span><span class="s">'hosts'</span><span class="sy">]</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-60"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># filter out hosts not in user's permission</span></div><div class="crayon-line" id="crayon-53c534042f940-61"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="e">hostname </span><span class="st">not</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">C</span><span class="sy">.</span><span class="v">DEFAULT_HOST_LIST</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-62"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">continue</span></div><div class="crayon-line" id="crayon-53c534042f940-63"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="st">not</span><span class="h"> </span><span class="e">hostname </span><span class="st">in</span><span class="h"> </span><span class="i">all_hosts</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-64"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">all_hosts</span><span class="sy">[</span><span class="i">hostname</span><span class="sy">]</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="e">Host</span><span class="sy">(</span><span class="i">hostname</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-65"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">host</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">all_hosts</span><span class="sy">[</span><span class="i">hostname</span><span class="sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-66"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">group</span><span class="sy">.</span><span class="e">add_host</span><span class="sy">(</span><span class="i">host</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-67">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-68"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="s">'vars'</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">data</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-69"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="i">k</span><span class="sy">,</span><span class="h"> </span><span class="i">v</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">data</span><span class="sy">[</span><span class="s">'vars'</span><span class="sy">]</span><span class="sy">.</span><span class="e">iteritems</span><span class="sy">(</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-70"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="i">group</span><span class="sy">.</span><span class="v">name</span><span class="h"> </span><span class="o">==</span><span class="h"> </span><span class="i">all</span><span class="sy">.</span><span class="v">name</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-71"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">all</span><span class="sy">.</span><span class="e">set_variable</span><span class="sy">(</span><span class="i">k</span><span class="sy">,</span><span class="h"> </span><span class="i">v</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-72"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">else</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-73"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">group</span><span class="sy">.</span><span class="e">set_variable</span><span class="sy">(</span><span class="i">k</span><span class="sy">,</span><span class="h"> </span><span class="i">v</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-74"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="i">group</span><span class="sy">.</span><span class="v">name</span><span class="h"> </span><span class="o">!=</span><span class="h"> </span><span class="i">all</span><span class="sy">.</span><span class="v">name</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-75"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">all</span><span class="sy">.</span><span class="e">add_child_group</span><span class="sy">(</span><span class="i">group</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-76">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-77"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="p"># Separate loop to ensure all groups are defined</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-78"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="sy">(</span><span class="i">group_name</span><span class="sy">,</span><span class="h"> </span><span class="i">data</span><span class="sy">)</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="v">raw</span><span class="sy">.</span><span class="e">items</span><span class="sy">(</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-79"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="v">group_name</span><span class="h"> </span><span class="o">==</span><span class="h"> </span><span class="s">'_meta'</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-80"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">continue</span></div><div class="crayon-line" id="crayon-53c534042f940-81"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="e">isinstance</span><span class="sy">(</span><span class="i">data</span><span class="sy">,</span><span class="h"> </span><span class="i">dict</span><span class="sy">)</span><span class="h"> </span><span class="st">and</span><span class="h"> </span><span class="s">'children'</span><span class="h"> </span><span class="st">in</span><span class="h"> </span><span class="i">data</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-82"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="e">child_name </span><span class="st">in</span><span class="h"> </span><span class="i">data</span><span class="sy">[</span><span class="s">'children'</span><span class="sy">]</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-83"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="e">child_name </span><span class="st">in</span><span class="h"> </span><span class="i">groups</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-84"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">groups</span><span class="sy">[</span><span class="i">group_name</span><span class="sy">]</span><span class="sy">.</span><span class="e">add_child_group</span><span class="sy">(</span><span class="i">groups</span><span class="sy">[</span><span class="i">child_name</span><span class="sy">]</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-85"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">return</span><span class="h"> </span><span class="e">groups</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-86">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-87"><span class="e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">def </span><span class="e">get_host_variables</span><span class="sy">(</span><span class="r">self</span><span class="sy">,</span><span class="h"> </span><span class="i">host</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-88"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">""</span><span class="s">" Runs &lt;script&gt; --host &lt;hostname&gt; to determine additional host variables "</span><span class="s">""</span></div><div class="crayon-line" id="crayon-53c534042f940-89"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="e">host_vars_from_top </span><span class="st">is</span><span class="h"> </span><span class="st">not</span><span class="h"> </span><span class="i">None</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-90"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">got</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="v">host_vars_from_top</span><span class="sy">.</span><span class="e">get</span><span class="sy">(</span><span class="i">host</span><span class="sy">.</span><span class="v">name</span><span class="sy">,</span><span class="h"> </span><span class="sy">{</span><span class="sy">}</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-91"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">return</span><span class="h"> </span><span class="e">got</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-92">&nbsp;</div><div class="crayon-line" id="crayon-53c534042f940-93"><span class="e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">cmd</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="sy">[</span><span class="r">self</span><span class="sy">.</span><span class="v">filename</span><span class="sy">,</span><span class="h"> </span><span class="s">"--host"</span><span class="sy">,</span><span class="h"> </span><span class="i">host</span><span class="sy">.</span><span class="v">name</span><span class="sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-94"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">try</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-95"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">sp</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">subprocess</span><span class="sy">.</span><span class="e">Popen</span><span class="sy">(</span><span class="i">cmd</span><span class="sy">,</span><span class="h"> </span><span class="v">stdout</span><span class="o">=</span><span class="i">subprocess</span><span class="sy">.</span><span class="v">PIPE</span><span class="sy">,</span><span class="h"> </span><span class="v">stderr</span><span class="o">=</span><span class="i">subprocess</span><span class="sy">.</span><span class="v">PIPE</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-96"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">except </span><span class="i">OSError</span><span class="sy">,</span><span class="h"> </span><span class="i">e</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042f940-97"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="e">raise </span><span class="i">errors</span><span class="sy">.</span><span class="e">AnsibleError</span><span class="sy">(</span><span class="s">"problem running %s (%s)"</span><span class="h"> </span><span class="o">%</span><span class="h"> </span><span class="sy">(</span><span class="s">' '</span><span class="sy">.</span><span class="e">join</span><span class="sy">(</span><span class="i">cmd</span><span class="sy">)</span><span class="sy">,</span><span class="h"> </span><span class="i">e</span><span class="sy">)</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f940-98"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">(</span><span class="i">out</span><span class="sy">,</span><span class="h"> </span><span class="i">err</span><span class="sy">)</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">sp</span><span class="sy">.</span><span class="e">communicate</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042f940-99"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">return</span><span class="h"> </span><span class="i">utils</span><span class="sy">.</span><span class="e">parse_json</span><span class="sy">(</span><span class="i">out</span><span class="sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0264 seconds] -->

</div>
<div>         从中可以得出如下结论：</div>
<div>
<ol>
<li>   ansible config，HOSTLIST的位置可以调整(ansible/constents.py)。</li>
<li>   HOSTLIST可以是文件，目录，可执行程序，并且目录可有无数层子目录，下面可以有无数个脚本或配置文件(ansible/inventory/__init__.py:70-107)。</li>
<li>   inventory Script不限定脚本语言，但至少需要实现&#8211;list 选项，并返回一个符合规则的json str，列出全量的机器列表，执行inventory Script阶段不支持传入自定义参数；另外可选的是，实现一个—host方法，返回机器的变量信息(ansible/inventory/script.py)，具体的来说，—list返回格式要求如下：</li>
</ol>
</div>
<div>
<!-- Crayon Syntax Highlighter v2.1.2 -->

		<div id="crayon-53c534042f9fc" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="height: 18px !important; line-height: 18px !important;"><span class="crayon-title">--list output</span>
			<div class="crayon-tools"><div class="crayon-button crayon-nums-button" title="切换显示行编号"></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"></div><div class="crayon-button crayon-expand-button" title="Expand Code"></div><div class="crayon-button crayon-copy-button" title="Expand Code"></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"></div><span class="crayon-language">JavaScript</span></div></div>
			<div class="crayon-info" style="min-height: 15px !important; line-height: 15px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
{
    "group1": [
        "host1",
        "host2"
    ],
    "group2": [
        "host3"
    ],
    "_meta": {//可选
        "hostvars": {//可选
            "host1": {
                "var1": "value1",
                "var2": "value2"
            },
            "host2": {
                "var3": "value3"
            }
        },
        "group1": {//可选
            "children": [
                “group2"
            ]
        }
    }
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-53c534042f9fc-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-2">2</div><div class="crayon-num" data-line="crayon-53c534042f9fc-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-4">4</div><div class="crayon-num" data-line="crayon-53c534042f9fc-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-6">6</div><div class="crayon-num" data-line="crayon-53c534042f9fc-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-8">8</div><div class="crayon-num" data-line="crayon-53c534042f9fc-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-10">10</div><div class="crayon-num" data-line="crayon-53c534042f9fc-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-12">12</div><div class="crayon-num" data-line="crayon-53c534042f9fc-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-14">14</div><div class="crayon-num" data-line="crayon-53c534042f9fc-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-16">16</div><div class="crayon-num" data-line="crayon-53c534042f9fc-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-18">18</div><div class="crayon-num" data-line="crayon-53c534042f9fc-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-20">20</div><div class="crayon-num" data-line="crayon-53c534042f9fc-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-22">22</div><div class="crayon-num" data-line="crayon-53c534042f9fc-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042f9fc-24">24</div><div class="crayon-num" data-line="crayon-53c534042f9fc-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-line" id="crayon-53c534042f9fc-1"><span class="sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-2"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"group1"</span><span class="o">:</span><span class="h"> </span><span class="sy">[</span></div><div class="crayon-line" id="crayon-53c534042f9fc-3"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"host1"</span><span class="sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-4"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"host2"</span></div><div class="crayon-line" id="crayon-53c534042f9fc-5"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">]</span><span class="sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-6"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"group2"</span><span class="o">:</span><span class="h"> </span><span class="sy">[</span></div><div class="crayon-line" id="crayon-53c534042f9fc-7"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"host3"</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-8"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">]</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f9fc-9"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"_meta"</span><span class="o">:</span><span class="h"> </span><span class="sy">{</span><span class="c">//可选</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-10"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"hostvars"</span><span class="o">:</span><span class="h"> </span><span class="sy">{</span><span class="c">//可选</span></div><div class="crayon-line" id="crayon-53c534042f9fc-11"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"host1"</span><span class="o">:</span><span class="h"> </span><span class="sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-12"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"var1"</span><span class="o">:</span><span class="h"> </span><span class="s">"value1"</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f9fc-13"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"var2"</span><span class="o">:</span><span class="h"> </span><span class="s">"value2"</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-14"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">}</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f9fc-15"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"host2"</span><span class="o">:</span><span class="h"> </span><span class="sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-16"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"var3"</span><span class="o">:</span><span class="h"> </span><span class="s">"value3"</span></div><div class="crayon-line" id="crayon-53c534042f9fc-17"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-18"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">}</span><span class="sy">,</span></div><div class="crayon-line" id="crayon-53c534042f9fc-19"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"group1"</span><span class="o">:</span><span class="h"> </span><span class="sy">{</span><span class="c">//可选</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-20"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">"children"</span><span class="o">:</span><span class="h"> </span><span class="sy">[</span></div><div class="crayon-line" id="crayon-53c534042f9fc-21"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>“<span class="i">group2</span>"</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-22"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">]</span></div><div class="crayon-line" id="crayon-53c534042f9fc-23"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042f9fc-24"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="sy">}</span></div><div class="crayon-line" id="crayon-53c534042f9fc-25"><span class="sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0035 seconds] -->
<br />
等效的hosts配置文件：</p>
</div>
<div>
<!-- Crayon Syntax Highlighter v2.1.2 -->

		<div id="crayon-53c534042fac4" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="height: 18px !important; line-height: 18px !important;"><span class="crayon-title">hosts.txt</span>
			<div class="crayon-tools"><div class="crayon-button crayon-nums-button" title="切换显示行编号"></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"></div><div class="crayon-button crayon-expand-button" title="Expand Code"></div><div class="crayon-button crayon-copy-button" title="Expand Code"></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"></div></div></div>
			<div class="crayon-info" style="min-height: 15px !important; line-height: 15px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
[group1]
host1 var1=value1 var2=value2
host2 var3=value2
[group2]
host3
[group1:children]
group2</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-53c534042fac4-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fac4-2">2</div><div class="crayon-num" data-line="crayon-53c534042fac4-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fac4-4">4</div><div class="crayon-num" data-line="crayon-53c534042fac4-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fac4-6">6</div><div class="crayon-num" data-line="crayon-53c534042fac4-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-line" id="crayon-53c534042fac4-1"><span class="sy">[</span><span class="i">group1</span><span class="sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fac4-2"><span class="e">host1 </span><span class="v">var1</span><span class="o">=</span><span class="e">value1 </span><span class="v">var2</span><span class="o">=</span><span class="e">value2</span></div><div class="crayon-line" id="crayon-53c534042fac4-3"><span class="e">host2 </span><span class="v">var3</span><span class="o">=</span><span class="i">value2</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fac4-4"><span class="sy">[</span><span class="i">group2</span><span class="sy">]</span></div><div class="crayon-line" id="crayon-53c534042fac4-5"><span class="i">host3</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fac4-6"><span class="sy">[</span><span class="i">group1</span><span class="o">:</span><span class="i">children</span><span class="sy">]</span></div><div class="crayon-line" id="crayon-53c534042fac4-7"><span class="i">group2</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->

</div>
<div>         因为python程序对于python环境十分敏感，所以我们强烈建议大家使用virtualenv将ansible及其环境部署到一个独立的目录，并且得益于结论1，我们可以将所有ansible相关的目录也收敛到此目录下，这样不但方便开发部署，也能避免对其它程序造成影响，我将我的环境统一放到了/usr/local/ansible下，并在activate脚本中export出了所有需要的变量，然后为用户alias了ago/back两个命令来进入和退出ansible环境。</div>
<div>
<!-- Crayon Syntax Highlighter v2.1.2 -->

		<div id="crayon-53c534042fb7c" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="height: 18px !important; line-height: 18px !important;"><span class="crayon-title">diff activate  activate.old</span>
			<div class="crayon-tools"><div class="crayon-button crayon-nums-button" title="切换显示行编号"></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"></div><div class="crayon-button crayon-expand-button" title="Expand Code"></div><div class="crayon-button crayon-copy-button" title="Expand Code"></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"></div><span class="crayon-language">diff</span></div></div>
			<div class="crayon-info" style="min-height: 15px !important; line-height: 15px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
49,51d48
&lt; VIRTUAL_ENV_DISABLE_PROMPT=1
&lt; ANSIBLE_CONFIG="$VIRTUAL_ENV/etc/ansible.cfg"
&lt;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-53c534042fb7c-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fb7c-2">2</div><div class="crayon-num" data-line="crayon-53c534042fb7c-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fb7c-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-line" id="crayon-53c534042fb7c-1">49,51d48</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fb7c-2"><span class="cn ">&lt; VIRTUAL_ENV_DISABLE_PROMPT=1</span></div><div class="crayon-line" id="crayon-53c534042fb7c-3"><span class="cn ">&lt; ANSIBLE_CONFIG="$VIRTUAL_ENV/etc/ansible.cfg"</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fb7c-4"><span class="h">&lt;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->

</div>
<div>
<!-- Crayon Syntax Highlighter v2.1.2 -->

		<div id="crayon-53c534042fc35" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="height: 18px !important; line-height: 18px !important;"><span class="crayon-title">/etc/profile.d/ansible.sh</span>
			<div class="crayon-tools"><div class="crayon-button crayon-nums-button" title="切换显示行编号"></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"></div><div class="crayon-button crayon-expand-button" title="Expand Code"></div><div class="crayon-button crayon-copy-button" title="Expand Code"></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"></div><span class="crayon-language">Shell</span></div></div>
			<div class="crayon-info" style="min-height: 15px !important; line-height: 15px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
#!/bin/bash

ANSIBLE_HOME=/usr/local/ansible
alias ago="source $ANSIBLE_HOME/bin/activate"
alias back="deactivate"</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-53c534042fc35-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fc35-2">2</div><div class="crayon-num" data-line="crayon-53c534042fc35-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fc35-4">4</div><div class="crayon-num" data-line="crayon-53c534042fc35-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-line" id="crayon-53c534042fc35-1"><span class="p">#!/bin/bash</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fc35-2">&nbsp;</div><div class="crayon-line" id="crayon-53c534042fc35-3"><span class="v">ANSIBLE_HOME</span><span class="o">=</span><span class="o">/</span><span class="i">usr</span><span class="o">/</span><span class="i">local</span><span class="o">/</span><span class="e">ansible</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fc35-4"><span class="r">alias</span><span class="h"> </span><span class="v">ago</span><span class="o">=</span><span class="s">"source $ANSIBLE_HOME/bin/activate"</span></div><div class="crayon-line" id="crayon-53c534042fc35-5"><span class="r">alias</span><span class="h"> </span><span class="v">back</span><span class="o">=</span><span class="s">"deactivate"</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->

</div>
<div>         基于2，我们可以将hosts搞成一个目录，然后如果你乐意的话，下面还可以再创建分类目录，方便归类管理。我的目录结构如下：</div>
<div>
<!-- Crayon Syntax Highlighter v2.1.2 -->

		<div id="crayon-53c534042fcec" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="height: 18px !important; line-height: 18px !important;"><span class="crayon-title">tree /usr/local/ansible/etc/</span>
			<div class="crayon-tools"><div class="crayon-button crayon-nums-button" title="切换显示行编号"></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"></div><div class="crayon-button crayon-expand-button" title="Expand Code"></div><div class="crayon-button crayon-copy-button" title="Expand Code"></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"></div></div></div>
			<div class="crayon-info" style="min-height: 15px !important; line-height: 15px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
/usr/local/ansible/etc/
├── ansible.cfg
└── hosts
    ├── xbox_global.ini
    └── xbox.py</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-53c534042fcec-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fcec-2">2</div><div class="crayon-num" data-line="crayon-53c534042fcec-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fcec-4">4</div><div class="crayon-num" data-line="crayon-53c534042fcec-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-line" id="crayon-53c534042fcec-1"><span class="o">/</span><span class="i">usr</span><span class="o">/</span><span class="i">local</span><span class="o">/</span><span class="i">ansible</span><span class="o">/</span><span class="i">etc</span><span class="o">/</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fcec-2">├──<span class="h"> </span><span class="i">ansible</span><span class="sy">.</span><span class="v">cfg</span></div><div class="crayon-line" id="crayon-53c534042fcec-3">└──<span class="h"> </span><span class="i">hosts</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fcec-4"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span>├──<span class="h"> </span><span class="i">xbox_global</span><span class="sy">.</span><span class="v">ini</span></div><div class="crayon-line" id="crayon-53c534042fcec-5"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span>└──<span class="h"> </span><span class="i">xbox</span><span class="sy">.</span><span class="v">py</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->

</div>
<div>         结论3中的那个“全量”再加上“不支持传入自定义参数”让我们有些头疼，实际上因为公司的机器成千上万，显然OP并不需要也不能每次运行ansible命令就拉全量机器列表，我们care的可能只有那么百十来台，可人家又不支持传入参数，怎么办？答案是：使用配置+cache，实际上官方提供的两个例子中也都使用了配置，不过配置这事，也需要安全的环境支撑，我们在第一版本中之所以没有用cache，是因为我们运行ansible的机器没有个人账号，呐，你敢不敢把token写文件里面放到上面？恐怕你连cache都不愿意放。说道这里我也特别提醒下，仅在足够安全的环境下使用我们最后提供的脚本。</div>
<div></div>
<div>         好了，现在我们脑海中就有个大体的轮廓了：只要写一个脚本，读取自定义配置，然后查询机器信息管理系统获得机器列表，实现到—list中方法，然后吐出一个合理的json，扔到ansible hosts目录下，机器列表的事情就搞定了，如果愿意，甚至可以连分组信息以及机器变量也搞定了。</div>
<div>         下面我们就开始动手写一个来试试了。</div>
<div></div>
<div>
<h4><strong>2. 动手</strong></h4>
</div>
<div>         首先我们来实现一个最简单的脚本，官方的两个示例都是很好的例子，cobber是获取机器列表(—list)的例子，ec2是获取机器信息(—host)的例子。我们下载cobber.py改起，我也画了下这个程序的流程图（<a href="http://noops.me/wp-content/uploads/2014/03/cobber%E6%B5%81%E7%A8%8B%E5%9B%BE.png" target="_blank">这里</a>），也可以到<a href="http://www.lucidchart.com/invitations/accept/531ebc3a-1d5c-4825-bc2c-4a6d0a00d013 " target="_blank">这里</a>查看带附注的版本（翻墙please&#8230;），看完后相信你会觉得这事太简单了，总的来说，我们只需要改动他read_settings，update_cache这两个方法。</div>
<div>         先来个简化的，不做任何可配置、容错检查以及排错支持，但骨架是全了：获取机器列表，并设置分组和变量信息，要做到这一点只需要添加两个函数，然后再盖一下update_cache就OK了：</div>
<div>
<!-- Crayon Syntax Highlighter v2.1.2 -->

		<div id="crayon-53c534042fda3" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; float: none; clear: both; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="height: 18px !important; line-height: 18px !important;"><span class="crayon-title">xbox.py</span>
			<div class="crayon-tools"><div class="crayon-button crayon-nums-button" title="切换显示行编号"></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"></div><div class="crayon-button crayon-expand-button" title="Expand Code"></div><div class="crayon-button crayon-copy-button" title="Expand Code"></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"></div><span class="crayon-language">Python</span></div></div>
			<div class="crayon-info" style="min-height: 15px !important; line-height: 15px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
    def get_host_list(self):
        '''根据用户配置从xbox获取机器列表'''

        http = httplib2.Http()
        url = “http://xbox.xiaomi.com/getMyHostlist?token=123&amp;tag=com.xiaomi”  #示例

            try:
                response, content = http.request(url, 'GET')
                # 检查返回是否正常
                if response.status != 200:
                    raise Exception('%s %s' % (response.status,response.reason))

                #返回结果类似: { “succ”:0; “hosts”:[“host1”,”host2”] }
                hosts = json.loads(content)[‘hosts’]
                for host in hosts:
                    self.push(self.inventory, 'all', host) # push是对append的一个封装
            except Exception, e:
                print e
                sys.exit(1)

    def get_host_tags(self):
        '''根据机器列表获得所有机器的tag和ip信息，并将tag作为分组名插入inventory’''

            http = httplib2.Http()
            hosts=‘_’.join(self.inventory[‘all'])
            url =  “http://xbox.xiaomi.com/getMyHosttags?token=123&amp;hosts=” + hosts #还是示例。。。
            try:
                response, content = http.request(url, 'GET')
                data = json.loads(content)

                #返回结果类似：{”succ“:0; “tag_list”:{“host1”:”com.xiaomi_dept.miliao_pdl.A_service.X,com.xiaomi_dept.miui_pdl.B_service.Y”}; ….}
                for host in json.loads(content)['tag_list'].keys():
                    self.cache[host] = dict()
                    ip = socket.gethostbyname(host)
                    self.cache[host]['ip'] = [ip]
                    tagstrs = json.loads(content)['tag_list'][host].split(',')
                    for tagstr in tagstrs:
                        for tag in tagstr.split(‘_'):
                            [key, value] = tag.split('.')
                            # 将tag作为hostvar保存
                            self.push(self.cache[host], key, value)
                            # 也将tag作为分组依据
                            group_name = '%s.%s' % (key, value)
                            self.push(self.inventory, group_name, host)
                        #将full tag string也作为hostvar和分组依据
                        self.push(self.inventory, tagstr, host)
                        self.push(self.cache[host], 'full_tags', tagstr)

            except Exception, e:
                print e
                sys.exit(1)

    def update_cache(self):
        """ Make calls to xbox and save the output in a cache """

        self.get_host_list()
        self.get_host_tags()

        self.write_to_cache(self.cache, self.cache_path_cache)
        self.write_to_cache(self.inventory, self.cache_path_inventory)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-53c534042fda3-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-2">2</div><div class="crayon-num" data-line="crayon-53c534042fda3-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-4">4</div><div class="crayon-num" data-line="crayon-53c534042fda3-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-6">6</div><div class="crayon-num" data-line="crayon-53c534042fda3-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-8">8</div><div class="crayon-num" data-line="crayon-53c534042fda3-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-10">10</div><div class="crayon-num" data-line="crayon-53c534042fda3-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-12">12</div><div class="crayon-num" data-line="crayon-53c534042fda3-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-14">14</div><div class="crayon-num" data-line="crayon-53c534042fda3-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-16">16</div><div class="crayon-num" data-line="crayon-53c534042fda3-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-18">18</div><div class="crayon-num" data-line="crayon-53c534042fda3-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-20">20</div><div class="crayon-num" data-line="crayon-53c534042fda3-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-22">22</div><div class="crayon-num" data-line="crayon-53c534042fda3-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-24">24</div><div class="crayon-num" data-line="crayon-53c534042fda3-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-26">26</div><div class="crayon-num" data-line="crayon-53c534042fda3-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-28">28</div><div class="crayon-num" data-line="crayon-53c534042fda3-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-30">30</div><div class="crayon-num" data-line="crayon-53c534042fda3-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-32">32</div><div class="crayon-num" data-line="crayon-53c534042fda3-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-34">34</div><div class="crayon-num" data-line="crayon-53c534042fda3-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-36">36</div><div class="crayon-num" data-line="crayon-53c534042fda3-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-38">38</div><div class="crayon-num" data-line="crayon-53c534042fda3-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-40">40</div><div class="crayon-num" data-line="crayon-53c534042fda3-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-42">42</div><div class="crayon-num" data-line="crayon-53c534042fda3-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-44">44</div><div class="crayon-num" data-line="crayon-53c534042fda3-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-46">46</div><div class="crayon-num" data-line="crayon-53c534042fda3-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-48">48</div><div class="crayon-num" data-line="crayon-53c534042fda3-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-50">50</div><div class="crayon-num" data-line="crayon-53c534042fda3-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-52">52</div><div class="crayon-num" data-line="crayon-53c534042fda3-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-54">54</div><div class="crayon-num" data-line="crayon-53c534042fda3-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-56">56</div><div class="crayon-num" data-line="crayon-53c534042fda3-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-58">58</div><div class="crayon-num" data-line="crayon-53c534042fda3-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-53c534042fda3-60">60</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-line" id="crayon-53c534042fda3-1"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">def</span><span class="h"> </span><span class="e">get_host_list</span><span class="sy">(</span><span class="r">self</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-2"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">'''根据用户配置从xbox获取机器列表'''</span></div><div class="crayon-line" id="crayon-53c534042fda3-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-4"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">http</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">httplib2</span><span class="sy">.</span><span class="e">Http</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042fda3-5"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">url</span><span class="h"> </span><span class="o">=</span><span class="h"> </span>“<span class="i">http</span><span class="o">:</span><span class="o">/</span><span class="o">/</span><span class="i">xbox</span><span class="sy">.</span><span class="v">xiaomi</span><span class="sy">.</span><span class="v">com</span><span class="o">/</span><span class="i">getMyHostlist</span><span class="sy">?</span><span class="k ">token</span><span class="o">=</span><span class="cn">123</span><span class="o">&amp;</span><span class="v">tag</span><span class="o">=</span><span class="i">com</span><span class="sy">.</span><span class="v">xiaomi</span>”<span class="h">&nbsp;&nbsp;</span><span class="c">#示例</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-6">&nbsp;</div><div class="crayon-line" id="crayon-53c534042fda3-7"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">try</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-8"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">response</span><span class="sy">,</span><span class="h"> </span><span class="v">content</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">http</span><span class="sy">.</span><span class="e">request</span><span class="sy">(</span><span class="i">url</span><span class="sy">,</span><span class="h"> </span><span class="s">'GET'</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042fda3-9"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c"># 检查返回是否正常</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-10"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">if</span><span class="h"> </span><span class="i">response</span><span class="sy">.</span><span class="v">status</span><span class="h"> </span><span class="o">!=</span><span class="h"> </span><span class="cn">200</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042fda3-11"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">raise</span><span class="h"> </span><span class="k ">Exception</span><span class="sy">(</span><span class="s">'%s %s'</span><span class="h"> </span><span class="o">%</span><span class="h"> </span><span class="sy">(</span><span class="i">response</span><span class="sy">.</span><span class="v">status</span><span class="sy">,</span><span class="i">response</span><span class="sy">.</span><span class="v">reason</span><span class="sy">)</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-12">&nbsp;</div><div class="crayon-line" id="crayon-53c534042fda3-13"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c">#返回结果类似: { “succ”:0; “hosts”:[“host1”,”host2”] }</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-14"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">hosts</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="k ">json</span><span class="sy">.</span><span class="e">loads</span><span class="sy">(</span><span class="i">content</span><span class="sy">)</span><span class="sy">[</span>‘<span class="i">hosts</span>’<span class="sy">]</span></div><div class="crayon-line" id="crayon-53c534042fda3-15"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="e">host </span><span class="st">in</span><span class="h"> </span><span class="i">hosts</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-16"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="e">push</span><span class="sy">(</span><span class="r">self</span><span class="sy">.</span><span class="v">inventory</span><span class="sy">,</span><span class="h"> </span><span class="s">'all'</span><span class="sy">,</span><span class="h"> </span><span class="i">host</span><span class="sy">)</span><span class="h"> </span><span class="c"># push是对append的一个封装</span></div><div class="crayon-line" id="crayon-53c534042fda3-17"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">except</span><span class="h"> </span><span class="k ">Exception</span><span class="sy">,</span><span class="h"> </span><span class="i">e</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-18"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="k ">print</span><span class="h"> </span><span class="i">e</span></div><div class="crayon-line" id="crayon-53c534042fda3-19"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="k ">sys</span><span class="sy">.</span><span class="e">exit</span><span class="sy">(</span><span class="cn">1</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-20">&nbsp;</div><div class="crayon-line" id="crayon-53c534042fda3-21"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">def</span><span class="h"> </span><span class="e">get_host_tags</span><span class="sy">(</span><span class="r">self</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-22"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">''</span><span class="s">'根据机器列表获得所有机器的tag和ip信息，并将tag作为分组名插入inventory’'</span><span class="s">'</span></div><div class="crayon-line" id="crayon-53c534042fda3-23">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-24"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http = httplib2.Http()</span></div><div class="crayon-line" id="crayon-53c534042fda3-25"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hosts=‘_’.join(self.inventory[‘all'</span><span class="sy">]</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-26"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">url</span><span class="h"> </span><span class="o">=</span><span class="h">&nbsp;&nbsp;</span>“<span class="i">http</span><span class="o">:</span><span class="o">/</span><span class="o">/</span><span class="i">xbox</span><span class="sy">.</span><span class="v">xiaomi</span><span class="sy">.</span><span class="v">com</span><span class="o">/</span><span class="i">getMyHosttags</span><span class="sy">?</span><span class="k ">token</span><span class="o">=</span><span class="cn">123</span><span class="o">&amp;</span><span class="v">hosts</span><span class="o">=</span>”<span class="h"> </span><span class="o">+</span><span class="h"> </span><span class="i">hosts</span><span class="h"> </span><span class="c">#还是示例。。。</span></div><div class="crayon-line" id="crayon-53c534042fda3-27"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">try</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-28"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="i">response</span><span class="sy">,</span><span class="h"> </span><span class="v">content</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="i">http</span><span class="sy">.</span><span class="e">request</span><span class="sy">(</span><span class="i">url</span><span class="sy">,</span><span class="h"> </span><span class="s">'GET'</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042fda3-29"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">data</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="k ">json</span><span class="sy">.</span><span class="e">loads</span><span class="sy">(</span><span class="i">content</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-30">&nbsp;</div><div class="crayon-line" id="crayon-53c534042fda3-31"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c">#返回结果类似：{”succ“:0; “tag_list”:{“host1”:”com.xiaomi_dept.miliao_pdl.A_service.X,com.xiaomi_dept.miui_pdl.B_service.Y”}; ….}</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-32"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="e">host </span><span class="st">in</span><span class="h"> </span><span class="k ">json</span><span class="sy">.</span><span class="e">loads</span><span class="sy">(</span><span class="i">content</span><span class="sy">)</span><span class="sy">[</span><span class="s">'tag_list'</span><span class="sy">]</span><span class="sy">.</span><span class="e">keys</span><span class="sy">(</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line" id="crayon-53c534042fda3-33"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">cache</span><span class="sy">[</span><span class="i">host</span><span class="sy">]</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="k ">dict</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-34"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">ip</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="k ">socket</span><span class="sy">.</span><span class="e">gethostbyname</span><span class="sy">(</span><span class="i">host</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042fda3-35"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="v">cache</span><span class="sy">[</span><span class="i">host</span><span class="sy">]</span><span class="sy">[</span><span class="s">'ip'</span><span class="sy">]</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="sy">[</span><span class="i">ip</span><span class="sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-36"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="v">tagstrs</span><span class="h"> </span><span class="o">=</span><span class="h"> </span><span class="k ">json</span><span class="sy">.</span><span class="e">loads</span><span class="sy">(</span><span class="i">content</span><span class="sy">)</span><span class="sy">[</span><span class="s">'tag_list'</span><span class="sy">]</span><span class="sy">[</span><span class="i">host</span><span class="sy">]</span><span class="sy">.</span><span class="e">split</span><span class="sy">(</span><span class="s">','</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042fda3-37"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="e">tagstr </span><span class="st">in</span><span class="h"> </span><span class="i">tagstrs</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-38"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">for</span><span class="h"> </span><span class="e">tag </span><span class="st">in</span><span class="h"> </span><span class="i">tagstr</span><span class="sy">.</span><span class="e">split</span><span class="sy">(</span>‘<span class="i">_</span><span class="s">'):</span></div><div class="crayon-line" id="crayon-53c534042fda3-39"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[key, value] = tag.split('</span><span class="sy">.</span><span class="s">')</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-40"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# 将tag作为hostvar保存</span></div><div class="crayon-line" id="crayon-53c534042fda3-41"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.push(self.cache[host], key, value)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-42"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# 也将tag作为分组依据</span></div><div class="crayon-line" id="crayon-53c534042fda3-43"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;group_name = '</span><span class="o">%</span><span class="i">s</span><span class="sy">.</span><span class="o">%</span><span class="i">s</span><span class="s">' % (key, value)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-44"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.push(self.inventory, group_name, host)</span></div><div class="crayon-line" id="crayon-53c534042fda3-45"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#将full tag string也作为hostvar和分组依据</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-46"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.push(self.inventory, tagstr, host)</span></div><div class="crayon-line" id="crayon-53c534042fda3-47"><span class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.push(self.cache[host], '</span><span class="i">full_tags</span>'<span class="sy">,</span><span class="h"> </span><span class="i">tagstr</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-48">&nbsp;</div><div class="crayon-line" id="crayon-53c534042fda3-49"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="st">except</span><span class="h"> </span><span class="k ">Exception</span><span class="sy">,</span><span class="h"> </span><span class="i">e</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-50"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="k ">print</span><span class="h"> </span><span class="i">e</span></div><div class="crayon-line" id="crayon-53c534042fda3-51"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="k ">sys</span><span class="sy">.</span><span class="e">exit</span><span class="sy">(</span><span class="cn">1</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-52">&nbsp;</div><div class="crayon-line" id="crayon-53c534042fda3-53"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">def</span><span class="h"> </span><span class="e">update_cache</span><span class="sy">(</span><span class="r">self</span><span class="sy">)</span><span class="o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-54"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="s">""" Make calls to xbox and save the output in a cache """</span></div><div class="crayon-line" id="crayon-53c534042fda3-55">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-56"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="e">get_host_list</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line" id="crayon-53c534042fda3-57"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="e">get_host_tags</span><span class="sy">(</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-58">&nbsp;</div><div class="crayon-line" id="crayon-53c534042fda3-59"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="e">write_to_cache</span><span class="sy">(</span><span class="r">self</span><span class="sy">.</span><span class="v">cache</span><span class="sy">,</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="v">cache_path_cache</span><span class="sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-53c534042fda3-60"><span class="h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="r">self</span><span class="sy">.</span><span class="e">write_to_cache</span><span class="sy">(</span><span class="r">self</span><span class="sy">.</span><span class="v">inventory</span><span class="sy">,</span><span class="h"> </span><span class="r">self</span><span class="sy">.</span><span class="v">cache_path_inventory</span><span class="sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0181 seconds] -->

</div>
<div>         上面的代码可读性好到屌爆，也许你替换url后还真能用，不过大多数情况下，你得到了一堆exception，恩没错，你的代码需要更多的裹脚布，然后，你需要尽可能的把配置抽取出来，像我还顺手加点小功能，于是到最后我的脚本达到了400多行。。</div>
<div>         恩，你一定会说，累死我了，给我脚本我自己看吧，好吧，请摆驾<a href="https://github.com/iambocai/ansible-plugins/tree/master/inventory_plugin" target="_blank">这里</a><a href="http://git.n.xiaomi.com/ansible/ansible-plugins"><br />
</a></div>
<div>         简单的说明下，这个脚本除了上面的主体功能外，还包括以下酱油功能：</div>
<div>          ·   管理员可配置：API URL , 用户配置模板获取位置，合理超时区间，封禁用户，用户缓存路径</div>
<div>          ·   用户可配置：token，关心的机器tags（就是all怎么获得），超时间隔</div>
<div></div>
<div>enjoy！</div>
            </div>
</div>

<footer>
    <p>
        This article was posted in <a href="http://noops.me/?cat=10" title="查看 python 中的全部文章" rel="category">python</a>, <a href="http://noops.me/?cat=11" title="查看 咸蛋 中的全部文章" rel="category">咸蛋</a>, <a href="http://noops.me/?cat=8" title="查看 运维工具 中的全部文章" rel="category">运维工具</a> and tagged <a href="http://noops.me/?tag=ansible" rel="tag">ansible</a>. Bookmark the <a href="http://noops.me/?p=1446" title="Permalink to ansible动手篇-如何书写自己的hosts脚本" rel="bookmark">permalink</a>. Follow comments with the <a href="http://noops.me/?feed=rss2&p=1446" title="Comments RSS to ansible动手篇-如何书写自己的hosts脚本" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
        
        <a class="comment-link" href="#respond" title="Post a Comment">Post a Comment</a> or leave a trackback: <a class="trackback-link" href="http://noops.me/wp-trackback.php?p=1446" title="Trackback URL for your post" rel="trackback">Trackback URL</a>.
            </p>
</footer>

<div id="comments"  class="clearfix">


    
    <div id="comments-list" class="comments">
    
        <h3 id="comments-title">
            3 Comments        </h3>
    
        <ol>
                <li id="comment-1323" class="comment even thread-even depth-1">
        <div class="comment-author vcard"><img alt='' src='http://1.gravatar.com/avatar/504d7e11a48f206d30e58506193cf054?s=80&amp;d=wavatar&amp;r=G' class='photo avatar avatar-80 photo' height='80' width='80' /> <span class="fn n">wilbur</span></div>
        <div class="comment-meta">
            2014/03/18 at 6:37 下午 <span class="meta-sep"> </span>        </div>
        
        
        <div class="comment-content">
            <p>我去，量产啊，可以用MD格式写，记着加下 more</p>
        </div>
        
        <div class="comment-reply-link"><a class='comment-reply-link' href='/?p=1446&#038;replytocom=1323#respond' onclick='return addComment.moveForm("comment-1323", "1323", "respond", "1446")'>Reply</a></div>
</li>
    <li id="comment-1324" class="comment byuser comment-author-iambocai bypostauthor odd alt thread-odd thread-alt depth-1">
        <div class="comment-author vcard"><img alt='' src='http://0.gravatar.com/avatar/0e9062d7b7e3d958e80f29d56e6ee07d?s=80&amp;d=wavatar&amp;r=G' class='photo avatar avatar-80 photo' height='80' width='80' /> <span class="fn n">iambocai</span></div>
        <div class="comment-meta">
            2014/03/18 at 8:04 下午 <span class="meta-sep"> </span>        </div>
        
        
        <div class="comment-content">
            <p>哈哈，我加下</p>
        </div>
        
        <div class="comment-reply-link"><a class='comment-reply-link' href='/?p=1446&#038;replytocom=1324#respond' onclick='return addComment.moveForm("comment-1324", "1324", "respond", "1446")'>Reply</a></div>
<ul class='children'>
    <li id="comment-1396" class="comment even depth-2">
        <div class="comment-author vcard"><img alt='' src='http://1.gravatar.com/avatar/777ff073a2d14bcc4499ece88e75607d?s=80&amp;d=wavatar&amp;r=G' class='photo avatar avatar-80 photo' height='80' width='80' /> <span class="fn n">loneavon</span></div>
        <div class="comment-meta">
            2014/04/20 at 9:16 下午 <span class="meta-sep"> </span>        </div>
        
        
        <div class="comment-content">
            <p>楼主给力！哈哈</p>
        </div>
        
        <div class="comment-reply-link"><a class='comment-reply-link' href='/?p=1446&#038;replytocom=1396#respond' onclick='return addComment.moveForm("comment-1396", "1396", "respond", "1446")'>Reply</a></div>
</li>
</ul>
</li>
        </ol>

        
    </div>
        
    
    								<div id="respond">
				<h3 id="reply-title">发表评论 <small><a rel="nofollow" id="cancel-comment-reply-link" href="/?p=1446#respond" style="display:none;">取消回复</a></small></h3>
									<form action="http://noops.me/wp-comments-post.php" method="post" id="commentform">
																										<p class="comment-form-author">
                <input type="text" name="author" id="author" value="" value="" size="30" tabindex="1" >
                <label for="author"><small>姓名 (required)</small></label> </p>
<p class="comment-form-email">
                <input type="text" name="email" id="email" value="" size="30" tabindex="2" >
                <label for="email"><small>电子邮件 (不会被公开) (required)</small></label> </p>
<p class="comment-form-url">
                <input type="text" name="url" id="url" value="" value="" size="30" tabindex="3">
                <label for="url"><small>站点</small></label> </p>
												<p><textarea name="comment" id="comment" cols="58" rows="10" tabindex="4"></textarea></p>												<p class="form-submit">
							<input name="submit" type="submit" id="submit" value="发表评论" />
							<input type='hidden' name='comment_post_ID' value='1446' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
						</p>
						<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="54adaacf8c" /></p>					</form>
							</div><!-- #respond -->
						
</div>
</article>

        
    </div>
    <aside class="sidebar thirds">
    <section class="widget-container widget_text" ><h1 class="widget-title">NoOps.me</h1>			<div class="textwidget">小米运维部非官方博客，关注系统、网络、运维、私有云、安全、数据库、内核...</div>
		</section><section class="widget-container better-gh-widget" ><h1 class="widget-title">xiaomi-sa@GitHub</h1><img width="128px" alt="GitHub Octocat" src="http://noops.me/wp-content/plugins/better-github-widget/octocat.png" style="display: block; margin: 0px auto;" /><p style="text-align: center; "><a href="http://github.com/xiaomi-sa/" >xiaomi-sa</a> @ GitHub</p><ul id="gh-repos"><li id="gh-loading">Status updating...</li></ul><script src="http://noops.me/wp-content/plugins/better-github-widget/github.js" type="text/javascript"> </script><script type="text/javascript">
        github.showRepos({
            user: 'xiaomi-sa',
            count: 0,
            skip_forks: false,
        });
  </script>
</section>		<section class="widget-container widget_recent_entries" >		<h1 class="widget-title">最新文章</h1>		<ul>
					<li>
				<a href="http://noops.me/?p=1505" title="lvs FullNAT顿卡问题原因追查">lvs FullNAT顿卡问题原因追查</a>
							<span class="post-date">2014/07/14</span>
						</li>
					<li>
				<a href="http://noops.me/?p=1496" title="小米自动化运维实践 qcon 2014 Beijing">小米自动化运维实践 qcon 2014 Beijing</a>
							<span class="post-date">2014/04/29</span>
						</li>
					<li>
				<a href="http://noops.me/?p=1483" title="报警助手介绍">报警助手介绍</a>
							<span class="post-date">2014/04/21</span>
						</li>
					<li>
				<a href="http://noops.me/?p=1471" title="linux单机监控工具falcon-eye介绍">linux单机监控工具falcon-eye介绍</a>
							<span class="post-date">2014/04/02</span>
						</li>
					<li>
				<a href="http://noops.me/?p=1446" title="ansible动手篇-如何书写自己的hosts脚本">ansible动手篇-如何书写自己的hosts脚本</a>
							<span class="post-date">2014/03/18</span>
						</li>
				</ul>
		</section><section class="widget-container widget_recent_comments" ><h1 class="widget-title">最近评论</h1><ul id="recentcomments"><li class="recentcomments">xdpan 发表在《<a href="http://noops.me/?p=1505#comment-1603">lvs FullNAT顿卡问题原因追查</a>》</li><li class="recentcomments"><a href='http://ljlion.sinaapp.com' rel='external nofollow' class='url'>lijian</a> 发表在《<a href="http://noops.me/?p=1505#comment-1602">lvs FullNAT顿卡问题原因追查</a>》</li><li class="recentcomments"><a href='http://ljlion.sinaapp.com' rel='external nofollow' class='url'>lijian</a> 发表在《<a href="http://noops.me/?p=1505#comment-1601">lvs FullNAT顿卡问题原因追查</a>》</li><li class="recentcomments">mtao 发表在《<a href="http://noops.me/?p=133#comment-1597">God进程监控框架</a>》</li><li class="recentcomments">wilbur 发表在《<a href="http://noops.me/?p=775#comment-1596">dsnat v2</a>》</li></ul></section><section class="widget-container widget_archive" ><h1 class="widget-title">文章归档</h1>		<ul>
			<li><a href='http://noops.me/?m=201407' title='2014 年七月'>2014 年七月</a></li>
	<li><a href='http://noops.me/?m=201404' title='2014 年四月'>2014 年四月</a></li>
	<li><a href='http://noops.me/?m=201403' title='2014 年三月'>2014 年三月</a></li>
	<li><a href='http://noops.me/?m=201402' title='2014 年二月'>2014 年二月</a></li>
	<li><a href='http://noops.me/?m=201312' title='2013 年十二月'>2013 年十二月</a></li>
	<li><a href='http://noops.me/?m=201311' title='2013 年十一月'>2013 年十一月</a></li>
	<li><a href='http://noops.me/?m=201310' title='2013 年十月'>2013 年十月</a></li>
	<li><a href='http://noops.me/?m=201309' title='2013 年九月'>2013 年九月</a></li>
	<li><a href='http://noops.me/?m=201308' title='2013 年八月'>2013 年八月</a></li>
	<li><a href='http://noops.me/?m=201307' title='2013 年七月'>2013 年七月</a></li>
	<li><a href='http://noops.me/?m=201306' title='2013 年六月'>2013 年六月</a></li>
	<li><a href='http://noops.me/?m=201305' title='2013 年五月'>2013 年五月</a></li>
	<li><a href='http://noops.me/?m=201304' title='2013 年四月'>2013 年四月</a></li>
	<li><a href='http://noops.me/?m=201303' title='2013 年三月'>2013 年三月</a></li>
	<li><a href='http://noops.me/?m=201302' title='2013 年二月'>2013 年二月</a></li>
		</ul>
</section><section class="widget-container widget_categories" ><h1 class="widget-title">文章分类</h1>		<ul>
	<li class="cat-item cat-item-3"><a href="http://noops.me/?cat=3" title="查看 CDN 下的所有文章">CDN</a>
</li>
	<li class="cat-item cat-item-44"><a href="http://noops.me/?cat=44" title="查看 dns 下的所有文章">dns</a>
</li>
	<li class="cat-item cat-item-82"><a href="http://noops.me/?cat=82" title="查看 golang 下的所有文章">golang</a>
</li>
	<li class="cat-item cat-item-86"><a href="http://noops.me/?cat=86" title="查看 IAAS/PAAS 下的所有文章">IAAS/PAAS</a>
</li>
	<li class="cat-item cat-item-9"><a href="http://noops.me/?cat=9" title="查看 linux系统 下的所有文章">linux系统</a>
</li>
	<li class="cat-item cat-item-66"><a href="http://noops.me/?cat=66" title="查看 lvs 下的所有文章">lvs</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://noops.me/?cat=20" title="查看 mysql 下的所有文章">mysql</a>
</li>
	<li class="cat-item cat-item-27"><a href="http://noops.me/?cat=27" title="查看 Network 下的所有文章">Network</a>
</li>
	<li class="cat-item cat-item-10"><a href="http://noops.me/?cat=10" title="查看 python 下的所有文章">python</a>
</li>
	<li class="cat-item cat-item-2"><a href="http://noops.me/?cat=2" title="查看 ruby 下的所有文章">ruby</a>
</li>
	<li class="cat-item cat-item-11"><a href="http://noops.me/?cat=11" title="查看 咸蛋 下的所有文章">咸蛋</a>
</li>
	<li class="cat-item cat-item-65"><a href="http://noops.me/?cat=65" title="查看 基础设施 下的所有文章">基础设施</a>
</li>
	<li class="cat-item cat-item-35"><a href="http://noops.me/?cat=35" title="查看 安全 下的所有文章">安全</a>
</li>
	<li class="cat-item cat-item-18"><a href="http://noops.me/?cat=18" title="查看 虚拟化 下的所有文章">虚拟化</a>
</li>
	<li class="cat-item cat-item-8"><a href="http://noops.me/?cat=8" title="查看 运维工具 下的所有文章">运维工具</a>
</li>
		</ul>
</section><section class="widget-container widget_tag_cloud" ><h1 class="widget-title">文章标签</h1><div class="tagcloud"><a href='http://noops.me/?tag=ansible' class='tag-link-97' title='2 个话题' style='font-size: 14.3pt;'>ansible</a>
<a href='http://noops.me/?tag=backup' class='tag-link-23' title='1 个话题' style='font-size: 8pt;'>backup</a>
<a href='http://noops.me/?tag=cdn-2' class='tag-link-42' title='1 个话题' style='font-size: 8pt;'>cdn</a>
<a href='http://noops.me/?tag=chroot' class='tag-link-37' title='1 个话题' style='font-size: 8pt;'>chroot</a>
<a href='http://noops.me/?tag=cloudfoundry' class='tag-link-6' title='3 个话题' style='font-size: 18.5pt;'>cloudfoundry</a>
<a href='http://noops.me/?tag=compress' class='tag-link-24' title='1 个话题' style='font-size: 8pt;'>compress</a>
<a href='http://noops.me/?tag=dba%e6%8b%9b%e8%81%98' class='tag-link-51' title='1 个话题' style='font-size: 8pt;'>DBA招聘</a>
<a href='http://noops.me/?tag=dns' class='tag-link-44' title='1 个话题' style='font-size: 8pt;'>dns</a>
<a href='http://noops.me/?tag=docker' class='tag-link-19' title='1 个话题' style='font-size: 8pt;'>docker</a>
<a href='http://noops.me/?tag=edns' class='tag-link-43' title='1 个话题' style='font-size: 8pt;'>edns</a>
<a href='http://noops.me/?tag=edns-client-subnet' class='tag-link-41' title='1 个话题' style='font-size: 8pt;'>edns-client-subnet</a>
<a href='http://noops.me/?tag=encrypt' class='tag-link-25' title='1 个话题' style='font-size: 8pt;'>encrypt</a>
<a href='http://noops.me/?tag=eventmachine' class='tag-link-7' title='1 个话题' style='font-size: 8pt;'>eventmachine</a>
<a href='http://noops.me/?tag=filetail' class='tag-link-32' title='1 个话题' style='font-size: 8pt;'>File::Tail</a>
<a href='http://noops.me/?tag=gist' class='tag-link-46' title='1 个话题' style='font-size: 8pt;'>gist</a>
<a href='http://noops.me/?tag=git' class='tag-link-45' title='1 个话题' style='font-size: 8pt;'>git</a>
<a href='http://noops.me/?tag=github-markdown-flaverd' class='tag-link-47' title='1 个话题' style='font-size: 8pt;'>github markdown flaverd</a>
<a href='http://noops.me/?tag=google_hacking' class='tag-link-34' title='1 个话题' style='font-size: 8pt;'>Google_Hacking</a>
<a href='http://noops.me/?tag=haproxy' class='tag-link-29' title='1 个话题' style='font-size: 8pt;'>haproxy</a>
<a href='http://noops.me/?tag=innodb' class='tag-link-22' title='1 个话题' style='font-size: 8pt;'>innodb</a>
<a href='http://noops.me/?tag=lxc' class='tag-link-16' title='1 个话题' style='font-size: 8pt;'>lxc</a>
<a href='http://noops.me/?tag=misaka' class='tag-link-48' title='1 个话题' style='font-size: 8pt;'>misaka</a>
<a href='http://noops.me/?tag=mysql' class='tag-link-20' title='1 个话题' style='font-size: 8pt;'>mysql</a>
<a href='http://noops.me/?tag=openssh' class='tag-link-38' title='1 个话题' style='font-size: 8pt;'>openssh</a>
<a href='http://noops.me/?tag=optimize' class='tag-link-30' title='1 个话题' style='font-size: 8pt;'>optimize</a>
<a href='http://noops.me/?tag=pcap' class='tag-link-36' title='1 个话题' style='font-size: 8pt;'>pcap</a>
<a href='http://noops.me/?tag=puppet' class='tag-link-39' title='1 个话题' style='font-size: 8pt;'>puppet</a>
<a href='http://noops.me/?tag=pygments' class='tag-link-49' title='1 个话题' style='font-size: 8pt;'>pygments</a>
<a href='http://noops.me/?tag=python' class='tag-link-10' title='1 个话题' style='font-size: 8pt;'>python</a>
<a href='http://noops.me/?tag=python%e7%a0%94%e5%8f%91%e5%b7%a5%e7%a8%8b%e5%b8%88%e6%8b%9b%e8%81%98' class='tag-link-52' title='1 个话题' style='font-size: 8pt;'>python研发工程师招聘</a>
<a href='http://noops.me/?tag=ruby' class='tag-link-2' title='4 个话题' style='font-size: 22pt;'>ruby</a>
<a href='http://noops.me/?tag=shell' class='tag-link-4' title='1 个话题' style='font-size: 8pt;'>shell</a>
<a href='http://noops.me/?tag=signal' class='tag-link-5' title='1 个话题' style='font-size: 8pt;'>signal</a>
<a href='http://noops.me/?tag=websocket' class='tag-link-31' title='1 个话题' style='font-size: 8pt;'>websocket</a>
<a href='http://noops.me/?tag=xtrabackup' class='tag-link-21' title='1 个话题' style='font-size: 8pt;'>xtrabackup</a>
<a href='http://noops.me/?tag=%e5%9f%9f%e5%90%8d%e7%9b%91%e6%8e%a7' class='tag-link-54' title='1 个话题' style='font-size: 8pt;'>域名监控</a>
<a href='http://noops.me/?tag=%e5%b0%8f%e7%b1%b3%e8%bf%90%e7%bb%b4' class='tag-link-50' title='2 个话题' style='font-size: 14.3pt;'>小米运维</a>
<a href='http://noops.me/?tag=%e8%99%9a%e6%8b%9f%e5%8c%96' class='tag-link-17' title='1 个话题' style='font-size: 8pt;'>虚拟化</a>
<a href='http://noops.me/?tag=%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1-%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86-zxtm-zeus-4-7%e4%ba%a4%e6%8d%a2%e6%9c%ba' class='tag-link-40' title='1 个话题' style='font-size: 8pt;'>负载均衡 流量管理 ZXTM ZEUS 4-7交换机</a>
<a href='http://noops.me/?tag=%e8%b5%84%e6%ba%90%e9%9a%94%e7%a6%bb' class='tag-link-15' title='1 个话题' style='font-size: 8pt;'>资源隔离</a>
<a href='http://noops.me/?tag=%e8%bf%90%e7%bb%b4%e5%b7%a5%e7%a8%8b%e5%b8%88%e6%8b%9b%e8%81%98' class='tag-link-53' title='1 个话题' style='font-size: 8pt;'>运维工程师招聘</a>
<a href='http://noops.me/?tag=%e8%bf%90%e7%bb%b4%e5%b9%b3%e5%8f%b0' class='tag-link-33' title='2 个话题' style='font-size: 14.3pt;'>运维平台</a>
<a href='http://noops.me/?tag=%e8%bf%90%e7%bb%b4%e6%a0%a1%e6%8b%9b%e7%ac%94%e8%af%95%e9%a2%98' class='tag-link-83' title='2 个话题' style='font-size: 14.3pt;'>运维校招笔试题</a>
<a href='http://noops.me/?tag=%e8%bf%90%e7%bb%b4%e8%87%aa%e5%8a%a8%e5%8c%96' class='tag-link-58' title='4 个话题' style='font-size: 22pt;'>运维自动化</a>
<a href='http://noops.me/?tag=%e8%bf%9b%e7%a8%8b%e7%9b%91%e6%8e%a7' class='tag-link-14' title='1 个话题' style='font-size: 8pt;'>进程监控</a></div>
</section><section class="widget-container widget_links" ><h1 class="widget-title">team</h1>
	<ul class='xoxo blogroll'>
<li><a href="http://laiwei.net" target="_blank">laiwei</a></li>
<li><a href="http://www.yubo.org">yubo</a></li>

	</ul>
</section>
<section class="widget-container widget_links" ><h1 class="widget-title">tech</h1>
	<ul class='xoxo blogroll'>
<li><a href="http://blog.hellosa.org" target="_blank">hellosa</a></li>
<li><a href="http://www.himysql.com" target="_blank">himysql</a></li>
<li><a href="http://chenlinux.com" title="三斗室" target="_blank">三斗室</a></li>
<li><a href="http://www.baidu-ops.com/" target="_blank">百度运维部</a></li>
<li><a href="http://linuxtone.org" rel="friend" title="运维专家网论坛" target="_blank">运维专家网</a></li>

	</ul>
</section>
<section class="widget-container widget_meta" ><h1 class="widget-title">功能</h1>			<ul>
			<li><a href="http://noops.me/wp-login.php?action=register">注册</a></li>			<li><a href="http://noops.me/wp-login.php">登录</a></li>
			<li><a href="http://noops.me/?feed=rss2" title="使用 RSS 2.0 订阅本站点内容">文章 <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://noops.me/?feed=comments-rss2" title="使用 RSS 订阅本站点的所有文章的近期评论">评论 <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://cn.wordpress.org/" title="基于 WordPress，一个优美、先进的个人信息发布平台。">WordPress.org</a></li>
						</ul>
</section></aside></div>
</div>

    <footer>
        <p id="copyright">&copy; NoOps, 2014. All Rights Reserved &nbsp;
        <script src="http://s17.cnzz.com/stat.php?id=5040484&web_id=5040484" language="JavaScript"></script></p>
    </footer>

    
</body>
</html>
